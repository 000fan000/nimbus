<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nimbus: /Users/featherless/workbench/ios/nimbus/src/ASIHTTPRequest/unittests/Tests/ASIHTTPRequestTests.m Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24278774-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
<body>
<div id="page">
<div style="position:relative">
<div id="top"><!-- do not remove this div! -->

<div id="titlearea">
<a style="float: right;margin-right:20px;margin-top:20px" href='http://www.pledgie.com/campaigns/15519'><img alt='Click here to support Nimbus development and make a donation at www.pledgie.com !' src='http://www.pledgie.com/campaigns/15519.png?skin_name=chrome' border='0' /></a>
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nimbus
   &#160;<span id="projectnumber">0.6.0 - <a href="http://github.com/jverkoey/nimbus">Nimbus is proudly hosted on Github</a></span>
   </div>
   <div id="projectbrief">An iOS framework whose growth is bounded by O(documentation).</div>
  </td>
  
  
  
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.4-20110629 -->
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_a_s_i_h_t_t_p_request_tests_8m.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">/Users/featherless/workbench/ios/nimbus/src/ASIHTTPRequest/unittests/Tests/ASIHTTPRequestTests.m</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">//  ASIHTTPRequestTests.m</span>
<a name="l00003"></a>00003 <span class="comment">//  Part of ASIHTTPRequest -&gt; http://allseeing-i.com/ASIHTTPRequest</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">//  Created by Ben Copsey on 01/08/2008.</span>
<a name="l00006"></a>00006 <span class="comment">//  Copyright 2008 All-Seeing Interactive. All rights reserved.</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#import &quot;ASIHTTPRequestTests.h&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#import &quot;ASIHTTPRequest.h&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#import &quot;ASINetworkQueue.h&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#import &quot;ASIFormDataRequest.h&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#import &lt;SystemConfiguration/SystemConfiguration.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#import &lt;unistd.h&gt;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="comment">// Used for subclass test</span>
<a name="l00017"></a>00017 <span class="keyword">@interface </span>ASIHTTPRequestSubclass : ASIHTTPRequest {}
<a name="l00018"></a>00018 <span class="keyword">@end</span>
<a name="l00019"></a>00019 <span class="keyword">@implementation </span>ASIHTTPRequestSubclass;
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">// For testing exceptions are caught</span>
<a name="l00022"></a>00022 - (void)startRequest
<a name="l00023"></a>00023 {
<a name="l00024"></a>00024         [[NSException exceptionWithName:@&quot;Test Exception&quot; reason:@&quot;Test Reason&quot; userInfo:nil] raise];
<a name="l00025"></a>00025 }
<a name="l00026"></a>00026 <span class="keyword">@end</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">// Stop clang complaining about undeclared selectors</span>
<a name="l00030"></a>00030 <span class="keyword">@interface </span>ASIHTTPRequestTests ()
<a name="l00031"></a>00031 - (void)runCancelTest;
<a name="l00032"></a>00032 - (void)performDelegateMethodsTest;
<a name="l00033"></a>00033 - (void)requestStarted:(ASIHTTPRequest *)request;
<a name="l00034"></a>00034 - (void)requestFinished:(ASIHTTPRequest *)request;
<a name="l00035"></a>00035 - (void)requestFailed:(ASIHTTPRequest *)request;
<a name="l00036"></a>00036 - (void)delegateTestStarted:(ASIHTTPRequest *)request;
<a name="l00037"></a>00037 - (void)delegateTestResponseHeaders:(ASIHTTPRequest *)request;
<a name="l00038"></a>00038 - (void)delegateTestFinished:(ASIHTTPRequest *)request;
<a name="l00039"></a>00039 - (void)delegateTestFailed:(ASIHTTPRequest *)request;
<a name="l00040"></a>00040 - (void)runRemoveUploadProgressTest;
<a name="l00041"></a>00041 - (void)runRedirectedResume;
<a name="l00042"></a>00042 - (void)performDownloadProgressTest;
<a name="l00043"></a>00043 - (void)theTestRequest:(ASIHTTPRequest *)request didReceiveData:(<a class="code" href="class_n_s_data.html" title="For hashing raw data.">NSData</a> *)data;
<a name="l00044"></a>00044 - (void)theTestRequestFinished:(ASIHTTPRequest *)request;
<a name="l00045"></a>00045 - (void)performUploadProgressTest;
<a name="l00046"></a>00046 - (void)performPostBodyStreamedFromDiskTest;
<a name="l00047"></a>00047 - (void)performPartialFetchTest;
<a name="l00048"></a>00048 - (void)asyncFail:(ASIHTTPRequest *)request;
<a name="l00049"></a>00049 - (void)asyncSuccess:(ASIHTTPRequest *)request;
<a name="l00050"></a>00050 - (void)request:(ASIHTTPRequest *)request isGoingToRedirectToURL:(NSURL *)url;
<a name="l00051"></a>00051 - (void)redirectURLTestFailed:(ASIHTTPRequest *)request;
<a name="l00052"></a>00052 - (void)redirectURLTestSucceeded:(ASIHTTPRequest *)request;
<a name="l00053"></a>00053 <span class="keyword">@end</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">@implementation </span>ASIHTTPRequestTests
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 - (void)testBasicDownload
<a name="l00058"></a>00058 {
<a name="l00059"></a>00059         NSURL *url = [NSURL URLWithString:@&quot;http://allseeing-i.com&quot;];
<a name="l00060"></a>00060         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url];
<a name="l00061"></a>00061         [request startSynchronous];
<a name="l00062"></a>00062         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *html = [request responseString];
<a name="l00063"></a>00063         GHAssertNotNil(html,<span class="stringliteral">@&quot;Basic synchronous request failed&quot;</span>);
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <span class="comment">// Check we&#39;re getting the correct response headers</span>
<a name="l00066"></a>00066         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *pingBackHeader = [[request responseHeaders] objectForKey:@&quot;X-Pingback&quot;];
<a name="l00067"></a>00067         BOOL success = [pingBackHeader isEqualToString:@&quot;http://allseeing-i.com/Ping-Back&quot;];
<a name="l00068"></a>00068         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to populate response headers&quot;</span>);
<a name="l00069"></a>00069         
<a name="l00070"></a>00070         <span class="comment">// Check we&#39;re getting back the correct status code</span>
<a name="l00071"></a>00071         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/a-page-that-does-not-exist&quot;] autorelease];
<a name="l00072"></a>00072         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00073"></a>00073         [request startSynchronous];
<a name="l00074"></a>00074         success = ([request responseStatusCode] == 404);
<a name="l00075"></a>00075         GHAssertTrue(success,<span class="stringliteral">@&quot;Didn&#39;t get correct status code&quot;</span>);        
<a name="l00076"></a>00076         
<a name="l00077"></a>00077         <span class="comment">// Check data is as expected</span>
<a name="l00078"></a>00078         NSRange notFound = NSMakeRange(NSNotFound, 0);
<a name="l00079"></a>00079         success = !NSEqualRanges([html rangeOfString:<span class="stringliteral">@&quot;All-Seeing Interactive&quot;</span>],notFound);
<a name="l00080"></a>00080         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to download the correct data&quot;</span>);
<a name="l00081"></a>00081         
<a name="l00082"></a>00082         <span class="comment">// Attempt to grab from bad url</span>
<a name="l00083"></a>00083         url = [[[NSURL alloc] initWithString:@&quot;&quot;] autorelease];
<a name="l00084"></a>00084         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00085"></a>00085         [request startSynchronous];
<a name="l00086"></a>00086         success = [[request error] code] == ASIInternalErrorWhileBuildingRequestType;
<a name="l00087"></a>00087         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to generate an error for a bad host&quot;</span>);
<a name="l00088"></a>00088         
<a name="l00089"></a>00089         request = [[[ASIHTTPRequest alloc] initWithURL:nil] autorelease];
<a name="l00090"></a>00090         [request startSynchronous];
<a name="l00091"></a>00091         success = [[request error] code] == ASIUnableToCreateRequestErrorType;
<a name="l00092"></a>00092         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to generate an error for a bad host&quot;</span>);
<a name="l00093"></a>00093 }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 - (void)testBase64Encode
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097         <a class="code" href="class_n_s_data.html" title="For hashing raw data.">NSData</a> *data = [@&quot;Hello, world&quot; dataUsingEncoding:NSUTF8StringEncoding];
<a name="l00098"></a>00098         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *base64 = [ASIHTTPRequest base64forData:data];
<a name="l00099"></a>00099         BOOL success = [base64 isEqualToString:@&quot;SGVsbG8sIHdvcmxk&quot;];
<a name="l00100"></a>00100         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to encode data using base64 data correctly&quot;</span>);
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 - (void)testCancel
<a name="l00104"></a>00104 {
<a name="l00105"></a>00105         <span class="comment">// We run this test on the main thread because otherwise we can&#39;t depend on the  delegate being notified before we need to test it&#39;s working</span>
<a name="l00106"></a>00106         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(runCancelTest) withObject:nil waitUntilDone:YES];
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 - (void)runCancelTest
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel_%28abridged%29.txt&quot;]];
<a name="l00113"></a>00113         [request startAsynchronous];
<a name="l00114"></a>00114         [request cancel];
<a name="l00115"></a>00115         [[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:2.0]];
<a name="l00116"></a>00116         GHAssertNotNil([request error],<span class="stringliteral">@&quot;Failed to cancel the request&quot;</span>);
<a name="l00117"></a>00117         
<a name="l00118"></a>00118         <span class="comment">// Test cancelling a redirected request works</span>
<a name="l00119"></a>00119         <span class="comment">// This test is probably unreliable on very slow or very fast connections, as it depends on being able to complete the first request (but not the second) in under 2 seconds</span>
<a name="l00120"></a>00120         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/cancel_redirect&quot;]];
<a name="l00121"></a>00121         [request startAsynchronous];
<a name="l00122"></a>00122         
<a name="l00123"></a>00123         [[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:2.0]];
<a name="l00124"></a>00124         [request cancel];
<a name="l00125"></a>00125         [[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:2.0]];
<a name="l00126"></a>00126         
<a name="l00127"></a>00127         BOOL success = ([[[request url] absoluteString] isEqualToString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel.txt&quot;]);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129         GHAssertTrue(success, <span class="stringliteral">@&quot;Request did not redirect quickly enough, cannot proceed with test&quot;</span>);
<a name="l00130"></a>00130         
<a name="l00131"></a>00131         GHAssertNotNil([request error],<span class="stringliteral">@&quot;Failed to cancel the request&quot;</span>);         
<a name="l00132"></a>00132         
<a name="l00133"></a>00133         success = [request totalBytesRead] &lt; 7900198;
<a name="l00134"></a>00134         GHAssertTrue(success, <span class="stringliteral">@&quot;Downloaded the whole of the response even though we should have cancelled by now&quot;</span>);
<a name="l00135"></a>00135         
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 - (void)testDelegateMethods
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143         <span class="comment">// We run this test on the main thread because otherwise we can&#39;t depend on the  delegate being notified before we need to test it&#39;s working</span>
<a name="l00144"></a>00144         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(performDelegateMethodsTest) withObject:nil waitUntilDone:YES];
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 - (void)performDelegateMethodsTest
<a name="l00148"></a>00148 {
<a name="l00149"></a>00149         started = NO;
<a name="l00150"></a>00150         finished = NO;
<a name="l00151"></a>00151         failed = NO;
<a name="l00152"></a>00152         
<a name="l00153"></a>00153         <span class="comment">// Test default delegate methods</span>
<a name="l00154"></a>00154         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l00155"></a>00155         [request setDelegate:self];
<a name="l00156"></a>00156         [request startSynchronous];
<a name="l00157"></a>00157 
<a name="l00158"></a>00158         
<a name="l00159"></a>00159         GHAssertTrue(started,<span class="stringliteral">@&quot;Failed to call the delegate method when the request started&quot;</span>);   
<a name="l00160"></a>00160         GHAssertTrue(receivedResponseHeaders,<span class="stringliteral">@&quot;Failed to call the delegate method when the request started&quot;</span>);   
<a name="l00161"></a>00161         GHAssertTrue(finished,<span class="stringliteral">@&quot;Failed to call the delegate method when the request finished&quot;</span>);
<a name="l00162"></a>00162         
<a name="l00163"></a>00163         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel.txt&quot;]];
<a name="l00164"></a>00164         [request setDelegate:self];
<a name="l00165"></a>00165         [request setTimeOutSeconds:0.01];
<a name="l00166"></a>00166         [request startSynchronous];
<a name="l00167"></a>00167         
<a name="l00168"></a>00168         GHAssertTrue(failed,<span class="stringliteral">@&quot;Failed to call the delegate method when the request failed&quot;</span>);
<a name="l00169"></a>00169         
<a name="l00170"></a>00170         started = NO;
<a name="l00171"></a>00171         finished = NO;
<a name="l00172"></a>00172         failed = NO;
<a name="l00173"></a>00173         receivedResponseHeaders = NO;
<a name="l00174"></a>00174         
<a name="l00175"></a>00175         <span class="comment">// Test custom delegate methods</span>
<a name="l00176"></a>00176         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l00177"></a>00177         [request setDelegate:self];
<a name="l00178"></a>00178         [request setDidStartSelector:@selector(delegateTestStarted:)];
<a name="l00179"></a>00179         [request setDidReceiveResponseHeadersSelector:@selector(delegateTestResponseHeaders:)];
<a name="l00180"></a>00180         [request setDidFinishSelector:@selector(delegateTestFinished:)];
<a name="l00181"></a>00181         [request startSynchronous];
<a name="l00182"></a>00182         
<a name="l00183"></a>00183 
<a name="l00184"></a>00184         GHAssertTrue(started,<span class="stringliteral">@&quot;Failed to call the delegate method when the request started&quot;</span>);   
<a name="l00185"></a>00185         GHAssertTrue(finished,<span class="stringliteral">@&quot;Failed to call the delegate method when the request finished&quot;</span>);
<a name="l00186"></a>00186         
<a name="l00187"></a>00187         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel.txt&quot;]];
<a name="l00188"></a>00188         [request setDidFailSelector:@selector(delegateTestFailed:)];
<a name="l00189"></a>00189         [request setDelegate:self];
<a name="l00190"></a>00190         [request setTimeOutSeconds:0.01];
<a name="l00191"></a>00191         [request startSynchronous];
<a name="l00192"></a>00192         
<a name="l00193"></a>00193         GHAssertTrue(failed,<span class="stringliteral">@&quot;Failed to call the delegate method when the request failed&quot;</span>);
<a name="l00194"></a>00194         
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 - (void)requestStarted:(ASIHTTPRequest *)request
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199         started = YES;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 - (void)request:(ASIHTTPRequest *)request didReceiveResponseHeaders:(NSDictionary *)newResponseHeaders
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204         GHAssertNotNil(newResponseHeaders,<span class="stringliteral">@&quot;Called request:didReceiveResponseHeaders: when we have no headers&quot;</span>);
<a name="l00205"></a>00205         receivedResponseHeaders = YES;
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 - (void)requestFinished:(ASIHTTPRequest *)request
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211         finished = YES;
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 - (void)requestFailed:(ASIHTTPRequest *)request
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216         failed = YES;
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 - (void)delegateTestStarted:(ASIHTTPRequest *)request
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221         started = YES;
<a name="l00222"></a>00222 }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 - (void)delegateTestResponseHeaders:(ASIHTTPRequest *)request
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226         GHAssertNotNil([request responseHeaders],<span class="stringliteral">@&quot;Called delegateTestResponseHeaders: when we have no headers&quot;</span>);
<a name="l00227"></a>00227         receivedResponseHeaders = YES;
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 - (void)delegateTestFinished:(ASIHTTPRequest *)request
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232         finished = YES;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 - (void)delegateTestFailed:(ASIHTTPRequest *)request
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237         failed = YES;
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 - (void)testConditionalGET
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/i/logo.png&quot;]];
<a name="l00243"></a>00243         [request startSynchronous];
<a name="l00244"></a>00244         BOOL success = ([request responseStatusCode] == 200);
<a name="l00245"></a>00245         GHAssertTrue(success, <span class="stringliteral">@&quot;Failed to download file, cannot proceed with this test&quot;</span>);
<a name="l00246"></a>00246         success = ([[request responseData] length] &gt; 0);
<a name="l00247"></a>00247         GHAssertTrue(success, <span class="stringliteral">@&quot;Response length is 0, this shouldn&#39;t happen&quot;</span>);
<a name="l00248"></a>00248         
<a name="l00249"></a>00249         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *etag = [[request responseHeaders] objectForKey:@&quot;Etag&quot;];
<a name="l00250"></a>00250         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *lastModified = [[request responseHeaders] objectForKey:@&quot;Last-Modified&quot;];
<a name="l00251"></a>00251         
<a name="l00252"></a>00252         GHAssertNotNil(etag, <span class="stringliteral">@&quot;Response didn&#39;t return an etag&quot;</span>);
<a name="l00253"></a>00253         GHAssertNotNil(lastModified, <span class="stringliteral">@&quot;Response didn&#39;t return a last modified date&quot;</span>);
<a name="l00254"></a>00254         
<a name="l00255"></a>00255         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/i/logo.png&quot;]];
<a name="l00256"></a>00256         [request addRequestHeader:@&quot;If-Modified-Since&quot; value:lastModified];
<a name="l00257"></a>00257         [request addRequestHeader:@&quot;If-None-Match&quot; value:etag];
<a name="l00258"></a>00258         [request startSynchronous];
<a name="l00259"></a>00259         success = ([request responseStatusCode] == 304);
<a name="l00260"></a>00260         GHAssertTrue(success, <span class="stringliteral">@&quot;Got wrong status code&quot;</span>);
<a name="l00261"></a>00261         success = ([[request responseData] length] == 0);
<a name="l00262"></a>00262         GHAssertTrue(success, <span class="stringliteral">@&quot;Response length is not 0, this shouldn&#39;t happen&quot;</span>);
<a name="l00263"></a>00263         
<a name="l00264"></a>00264 }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 - (void)testException
<a name="l00267"></a>00267 {
<a name="l00268"></a>00268         ASIHTTPRequestSubclass *request = [ASIHTTPRequestSubclass requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l00269"></a>00269         [request startSynchronous];
<a name="l00270"></a>00270         NSError *error = [request error];
<a name="l00271"></a>00271         GHAssertNotNil(error,<span class="stringliteral">@&quot;Failed to generate an error for an exception&quot;</span>);
<a name="l00272"></a>00272         
<a name="l00273"></a>00273         BOOL success = [[[error userInfo] objectForKey:NSLocalizedDescriptionKey] isEqualToString:@&quot;Test Exception&quot;];
<a name="l00274"></a>00274         GHAssertTrue(success, <span class="stringliteral">@&quot;Generated wrong error for exception&quot;</span>);
<a name="l00275"></a>00275         
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 - (void)testCharacterEncoding
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280         
<a name="l00281"></a>00281         NSArray *IANAEncodings = [NSArray arrayWithObjects:@&quot;UTF-8&quot;,@&quot;US-ASCII&quot;,@&quot;ISO-8859-1&quot;,@&quot;UTF-16&quot;,nil];
<a name="l00282"></a>00282         NSUInteger NSStringEncodings[] = {NSUTF8StringEncoding,NSASCIIStringEncoding,NSISOLatin1StringEncoding,NSUnicodeStringEncoding};
<a name="l00283"></a>00283         
<a name="l00284"></a>00284         NSUInteger i;
<a name="l00285"></a>00285         <span class="keywordflow">for</span> (i=0; i&lt;[IANAEncodings count]; i++) {
<a name="l00286"></a>00286                 NSURL *url = [[[NSURL alloc] initWithString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/Character-Encoding/%@&quot;,[IANAEncodings objectAtIndex:i]]] autorelease];
<a name="l00287"></a>00287                 ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00288"></a>00288                 [request startSynchronous];
<a name="l00289"></a>00289                 BOOL success = [request responseEncoding] == NSStringEncodings[i];
<a name="l00290"></a>00290                 GHAssertTrue(success,[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:<span class="stringliteral">@&quot;Failed to use the correct text encoding for %@i&quot;</span>,[IANAEncodings objectAtIndex:i]]);
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292                                          
<a name="l00293"></a>00293         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/Character-Encoding/Something-else&quot;] autorelease];
<a name="l00294"></a>00294         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00295"></a>00295         [request setDefaultResponseEncoding:NSWindowsCP1251StringEncoding];
<a name="l00296"></a>00296         [request startSynchronous];
<a name="l00297"></a>00297         BOOL success = [request responseEncoding] == [request defaultResponseEncoding];
<a name="l00298"></a>00298         GHAssertTrue(success,[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:<span class="stringliteral">@&quot;Failed to use the default string encoding&quot;</span>]);
<a name="l00299"></a>00299         
<a name="l00300"></a>00300         <span class="comment">// Will return a Content-Type header with charset in the middle of the value (Fix contributed by Roman Busyghin)</span>
<a name="l00301"></a>00301         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/Character-Encoding/utf-16-with-type-header&quot;] autorelease];
<a name="l00302"></a>00302         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00303"></a>00303         [request startSynchronous];
<a name="l00304"></a>00304         success = [request responseEncoding] == NSUnicodeStringEncoding;
<a name="l00305"></a>00305         GHAssertTrue(success,[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:<span class="stringliteral">@&quot;Failed to parse the content type header correctly&quot;</span>]);
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 - (void)testTimeOut
<a name="l00309"></a>00309 {
<a name="l00310"></a>00310         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel_%28abridged%29.txt&quot;] autorelease];
<a name="l00311"></a>00311         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00312"></a>00312         [request setTimeOutSeconds:0.0001]; <span class="comment">//It&#39;s pretty unlikely we will be able to grab the data this quickly, so the request should timeout</span>
<a name="l00313"></a>00313         [request startSynchronous];
<a name="l00314"></a>00314         
<a name="l00315"></a>00315         BOOL success = [[request error] code] == ASIRequestTimedOutErrorType;
<a name="l00316"></a>00316         GHAssertTrue(success,<span class="stringliteral">@&quot;Timeout didn&#39;t generate the correct error&quot;</span>);
<a name="l00317"></a>00317         
<a name="l00318"></a>00318         [ASIHTTPRequest setDefaultTimeOutSeconds:0.0001];
<a name="l00319"></a>00319         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00320"></a>00320         [request startSynchronous];
<a name="l00321"></a>00321         
<a name="l00322"></a>00322         success = [[request error] code] == ASIRequestTimedOutErrorType;
<a name="l00323"></a>00323         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to change the default timeout&quot;</span>);  
<a name="l00324"></a>00324         
<a name="l00325"></a>00325         [ASIHTTPRequest setDefaultTimeOutSeconds:10];
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="comment">// Test fix for a bug that might have caused timeouts when posting data</span>
<a name="l00330"></a>00330 - (void)testTimeOutWithoutDownloadDelegate
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel_%28young_readers_edition%29.txt&quot;]];
<a name="l00333"></a>00333         [request setTimeOutSeconds:5];
<a name="l00334"></a>00334         [request setShowAccurateProgress:NO];
<a name="l00335"></a>00335         [request setPostBody:[NSMutableData dataWithData:[@&quot;Small Body&quot; dataUsingEncoding:NSUTF8StringEncoding]]];
<a name="l00336"></a>00336         [request startSynchronous];
<a name="l00337"></a>00337         
<a name="l00338"></a>00338         GHAssertNil([request error],<span class="stringliteral">@&quot;Generated an error (most likely a timeout) - this test might fail on high latency connections&quot;</span>);  
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 - (void)testRequestMethod
<a name="l00343"></a>00343 {
<a name="l00344"></a>00344         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/request-method&quot;] autorelease];
<a name="l00345"></a>00345         NSArray *methods = [[[NSArray alloc] initWithObjects:@&quot;GET&quot;,@&quot;POST&quot;,@&quot;PUT&quot;,@&quot;DELETE&quot;, nil] autorelease];
<a name="l00346"></a>00346         <span class="keywordflow">for</span> (<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *method in methods) {
<a name="l00347"></a>00347                 ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00348"></a>00348                 [request setRequestMethod:method];
<a name="l00349"></a>00349                 [request startSynchronous];
<a name="l00350"></a>00350                 BOOL success = [[request responseString] isEqualToString:method];
<a name="l00351"></a>00351                 GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to set the request method correctly&quot;</span>);    
<a name="l00352"></a>00352         }
<a name="l00353"></a>00353         
<a name="l00354"></a>00354         <span class="comment">// Test to ensure we don&#39;t change the request method when we have an unrecognised method already set</span>
<a name="l00355"></a>00355         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00356"></a>00356         [request setRequestMethod:@&quot;FINK&quot;];
<a name="l00357"></a>00357         [request appendPostData:[@&quot;King&quot; dataUsingEncoding:NSUTF8StringEncoding]];
<a name="l00358"></a>00358         [request buildPostBody];
<a name="l00359"></a>00359         BOOL success = [[request requestMethod] isEqualToString:@&quot;FINK&quot;];
<a name="l00360"></a>00360         GHAssertTrue(success,<span class="stringliteral">@&quot;Erroneously changed request method&quot;</span>);    
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 - (void)testHTTPVersion
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/http-version&quot;] autorelease];
<a name="l00366"></a>00366         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00367"></a>00367         [request startSynchronous];
<a name="l00368"></a>00368         
<a name="l00369"></a>00369         BOOL success = [[request responseString] isEqualToString:@&quot;HTTP/1.1&quot;];
<a name="l00370"></a>00370         GHAssertTrue(success,<span class="stringliteral">@&quot;Wrong HTTP version used (May fail when using a proxy that changes the HTTP version!)&quot;</span>);
<a name="l00371"></a>00371         
<a name="l00372"></a>00372         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00373"></a>00373         [request setUseHTTPVersionOne:YES];
<a name="l00374"></a>00374         [request startSynchronous];
<a name="l00375"></a>00375         
<a name="l00376"></a>00376         success = [[request responseString] isEqualToString:@&quot;HTTP/1.0&quot;];
<a name="l00377"></a>00377         GHAssertTrue(success,<span class="stringliteral">@&quot;Wrong HTTP version used (May fail when using a proxy that changes the HTTP version!)&quot;</span>);  
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 - (void)testUserAgent
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382         <span class="comment">// defaultUserAgentString will be nil if we haven&#39;t set a Bundle Name or Bundle Display Name</span>
<a name="l00383"></a>00383         <span class="keywordflow">if</span> ([ASIHTTPRequest defaultUserAgentString]) {
<a name="l00384"></a>00384                 
<a name="l00385"></a>00385                 <span class="comment">// Returns the user agent it received in the response body</span>
<a name="l00386"></a>00386                 ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/user-agent&quot;]];
<a name="l00387"></a>00387                 [request startSynchronous];
<a name="l00388"></a>00388                 BOOL success = [[request responseString] isEqualToString:[ASIHTTPRequest defaultUserAgentString]];
<a name="l00389"></a>00389                 GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to set the correct user agent&quot;</span>);
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *customUserAgent = <span class="stringliteral">@&quot;Ferdinand Fuzzworth&#39;s Magic Tent of Mystery&quot;</span>;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394         <span class="comment">// Test specifying a custom user-agent for a single request</span>
<a name="l00395"></a>00395         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/user-agent&quot;]];
<a name="l00396"></a>00396         [request addRequestHeader:@&quot;User-Agent&quot; value:customUserAgent];
<a name="l00397"></a>00397         [request startSynchronous];
<a name="l00398"></a>00398         BOOL success = [[request responseString] isEqualToString:customUserAgent];
<a name="l00399"></a>00399         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to set the correct user-agent for a single request&quot;</span>);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="comment">// Test again using userAgent</span>
<a name="l00402"></a>00402         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/user-agent&quot;]];
<a name="l00403"></a>00403         [request setUserAgent:customUserAgent];
<a name="l00404"></a>00404         [request startSynchronous];
<a name="l00405"></a>00405         success = [[request responseString] isEqualToString:customUserAgent];
<a name="l00406"></a>00406         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to set the correct user-agent for a single request&quot;</span>);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         <span class="comment">// Test again to ensure user-agent not reused</span>
<a name="l00409"></a>00409         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/user-agent&quot;]];
<a name="l00410"></a>00410         [request startSynchronous];
<a name="l00411"></a>00411         success = ![[request responseString] isEqualToString:customUserAgent];
<a name="l00412"></a>00412         GHAssertTrue(success,<span class="stringliteral">@&quot;Re-used a user agent when we shouldn&#39;t have done so&quot;</span>);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         <span class="comment">// Test setting a custom default user-agent string</span>
<a name="l00415"></a>00415         [ASIHTTPRequest setDefaultUserAgentString:customUserAgent];
<a name="l00416"></a>00416         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/user-agent&quot;]];
<a name="l00417"></a>00417         [request startSynchronous];
<a name="l00418"></a>00418         success = [[request responseString] isEqualToString:customUserAgent];
<a name="l00419"></a>00419         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to set the correct user-agent when using a custom default&quot;</span>);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         [ASIHTTPRequest setDefaultUserAgentString:nil];
<a name="l00422"></a>00422         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/user-agent&quot;]];
<a name="l00423"></a>00423         [request startSynchronous];
<a name="l00424"></a>00424         success = ![[request responseString] isEqualToString:customUserAgent];
<a name="l00425"></a>00425         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to clear a custom default user-agent&quot;</span>);
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 - (void)testAutomaticRedirection
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430         ASIHTTPRequest *request;
<a name="l00431"></a>00431         ASIFormDataRequest *request2;
<a name="l00432"></a>00432         BOOL success;
<a name="l00433"></a>00433         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l00434"></a>00434         <span class="keywordflow">for</span> (i=301; i&lt;308; i++) {
<a name="l00435"></a>00435                 
<a name="l00436"></a>00436                 <span class="keywordflow">if</span> (i &gt; 304 &amp;&amp; i &lt; 307) {
<a name="l00437"></a>00437                         <span class="keywordflow">continue</span>;
<a name="l00438"></a>00438                 }
<a name="l00439"></a>00439                 NSURL *url = [NSURL URLWithString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect/%hi&quot;,i]];
<a name="l00440"></a>00440                 request = [ASIHTTPRequest requestWithURL:url];
<a name="l00441"></a>00441                 [request setShouldRedirect:NO];
<a name="l00442"></a>00442                 [request startSynchronous];
<a name="l00443"></a>00443                 <span class="keywordflow">if</span> (i == 304) { <span class="comment">// 304s will not contain a body, as per rfc2616. Will test 304 handling in a future test when we have etag support</span>
<a name="l00444"></a>00444                         <span class="keywordflow">continue</span>;
<a name="l00445"></a>00445                 }
<a name="l00446"></a>00446                 success = [[request responseString] isEqualToString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;Non-redirected content with %hi status code&quot;,i]];
<a name="l00447"></a>00447                 GHAssertTrue(success,[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:<span class="stringliteral">@&quot;Got the wrong content when not redirecting after a %hi&quot;</span>,i]);
<a name="l00448"></a>00448         
<a name="l00449"></a>00449                 request2 = [ASIFormDataRequest requestWithURL:url];
<a name="l00450"></a>00450                 [request2 setPostValue:@&quot;Giant Monkey&quot; forKey:@&quot;lookbehindyou&quot;];
<a name="l00451"></a>00451                 [request2 startSynchronous];
<a name="l00452"></a>00452                 
<a name="l00453"></a>00453                 <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *method = <span class="stringliteral">@&quot;GET&quot;</span>;
<a name="l00454"></a>00454                 <span class="keywordflow">if</span> (i&gt;304) {
<a name="l00455"></a>00455                         method = <span class="stringliteral">@&quot;POST&quot;</span>;       
<a name="l00456"></a>00456                 }
<a name="l00457"></a>00457                 <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *expectedString = [<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;Redirected as %@ after a %hi status code&quot;,method,i];
<a name="l00458"></a>00458                 <span class="keywordflow">if</span> (i&gt;304) {
<a name="l00459"></a>00459                         expectedString = [<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;%@\r\nWatch out for the Giant Monkey!&quot;,expectedString];
<a name="l00460"></a>00460                 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462                 success = [[request2 responseString] isEqualToString:expectedString];
<a name="l00463"></a>00463                 GHAssertTrue(success,[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:<span class="stringliteral">@&quot;Got the wrong content when redirecting after a %hi&quot;</span>,i]);
<a name="l00464"></a>00464         
<a name="l00465"></a>00465                 success = ([request2 responseStatusCode] == 200);
<a name="l00466"></a>00466                 GHAssertTrue(success,<span class="stringliteral">@&quot;Got the wrong status code (expected 200)&quot;</span>);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         }
<a name="l00469"></a>00469         
<a name="l00470"></a>00470         <span class="comment">// Test RFC 2616 behaviour</span>
<a name="l00471"></a>00471         <span class="keywordflow">for</span> (i=301; i&lt;303; i++) {
<a name="l00472"></a>00472                 
<a name="l00473"></a>00473                 NSURL *url = [NSURL URLWithString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect/%hi&quot;,i]];
<a name="l00474"></a>00474                 request2 = [ASIFormDataRequest requestWithURL:url];
<a name="l00475"></a>00475                 [request2 setPostValue:@&quot;Giant Monkey&quot; forKey:@&quot;lookbehindyou&quot;];
<a name="l00476"></a>00476                 [request2 setShouldUseRFC2616RedirectBehaviour:YES];
<a name="l00477"></a>00477                 [request2 startSynchronous];
<a name="l00478"></a>00478                 
<a name="l00479"></a>00479                 success = ([request2 responseStatusCode] == 200);
<a name="l00480"></a>00480                 GHAssertTrue(success,<span class="stringliteral">@&quot;Got the wrong status code (expected 200)&quot;</span>);      
<a name="l00481"></a>00481 
<a name="l00482"></a>00482                 <span class="keywordflow">if</span> (i == 303) {
<a name="l00483"></a>00483                         success = ([request2 postLength] == 0 &amp;&amp; ![request2 postBody] &amp;&amp; [[request2 requestMethod] isEqualToString:@&quot;GET&quot;]);
<a name="l00484"></a>00484                         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to reset request to GET on 303 redirect&quot;</span>);
<a name="l00485"></a>00485                         
<a name="l00486"></a>00486                         success = [[request2 responseString] isEqualToString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;Redirected as GET after a %hi status code&quot;,i]];
<a name="l00487"></a>00487                         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to dump the post body on 303 redirect&quot;</span>);
<a name="l00488"></a>00488                         
<a name="l00489"></a>00489                 } <span class="keywordflow">else</span> {
<a name="l00490"></a>00490                         success = ([request2 postLength] &gt; 0 || ![request2 postBody] || ![[request2 requestMethod] isEqualToString:@&quot;POST&quot;]);
<a name="l00491"></a>00491                         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to use the same request method and body for a redirect when using rfc2616 behaviour&quot;</span>);
<a name="l00492"></a>00492                 
<a name="l00493"></a>00493                         success = ([[request2 responseString] isEqualToString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;Redirected as POST after a %hi status code\r\nWatch out for the Giant Monkey!&quot;,i]]);
<a name="l00494"></a>00494                         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to send the correct post body on redirect&quot;</span>);
<a name="l00495"></a>00495                 }
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497         
<a name="l00498"></a>00498         <span class="comment">// Ensure the file contains only the body of the last request (after redirects) when downloading to a file</span>
<a name="l00499"></a>00499         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect/301&quot;]];
<a name="l00500"></a>00500         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *path = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;test.txt&quot;];
<a name="l00501"></a>00501         [request setDownloadDestinationPath:path];
<a name="l00502"></a>00502         [request startSynchronous];
<a name="l00503"></a>00503         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *result = [<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:nil];
<a name="l00504"></a>00504         success = [result isEqualToString:@&quot;Redirected as GET after a 301 status code&quot;];
<a name="l00505"></a>00505         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to store just the body of the file request on redirect&quot;</span>);
<a name="l00506"></a>00506         
<a name="l00507"></a>00507         success = ([request originalURL] != [request url]);
<a name="l00508"></a>00508         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to update request url on redirection&quot;</span>);
<a name="l00509"></a>00509         
<a name="l00510"></a>00510         success = ([[[request originalURL] absoluteString] isEqualToString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect/301&quot;]);
<a name="l00511"></a>00511         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to preserve original url&quot;</span>);       
<a name="l00512"></a>00512 
<a name="l00513"></a>00513         <span class="comment">// Ensure user agent is preserved</span>
<a name="l00514"></a>00514         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect/301&quot;]];
<a name="l00515"></a>00515         [request addRequestHeader:@&quot;User-Agent&quot; value:@&quot;test&quot;];
<a name="l00516"></a>00516         [request startSynchronous];
<a name="l00517"></a>00517         success = ([[[request requestHeaders] objectForKey:@&quot;User-Agent&quot;] isEqualToString:@&quot;test&quot;]);
<a name="l00518"></a>00518         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to preserve original user agent on redirect&quot;</span>);
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 <span class="comment">// Using a persistent connection for HTTP 305-307 would cause crashes on the redirect, not really sure why</span>
<a name="l00522"></a>00522 <span class="comment">// Since 305 (use proxy) wasn&#39;t properly supported anyway, 306 is unused, and clients are supposed to confirm redirects for 307, I&#39;ve simply removed automatic redirect for these codes</span>
<a name="l00523"></a>00523 - (void)test30xCrash
<a name="l00524"></a>00524 {
<a name="l00525"></a>00525         <span class="keywordtype">int</span> i;
<a name="l00526"></a>00526         <span class="keywordflow">for</span> (i=305; i&lt;308; i++) {
<a name="l00527"></a>00527                 ASIFormDataRequest *request = [ASIFormDataRequest requestWithURL:[NSURL URLWithString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect/%hi&quot;,i]]];
<a name="l00528"></a>00528                 [request setPostValue:@&quot;foo&quot; forKey:@&quot;eep&quot;];
<a name="l00529"></a>00529                 [request setShouldRedirect:NO];
<a name="l00530"></a>00530                 [request startSynchronous];
<a name="l00531"></a>00531                 request = [ASIFormDataRequest requestWithURL:[NSURL URLWithString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect/%hi&quot;,i]]];
<a name="l00532"></a>00532                 [request setPostValue:@&quot;foo&quot; forKey:@&quot;eep&quot;];
<a name="l00533"></a>00533                 [request startSynchronous];
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 - (void)testResumeChecksContentRangeHeader
<a name="l00538"></a>00538 {
<a name="l00539"></a>00539         NSURL *url = [NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/no_resume&quot;];
<a name="l00540"></a>00540         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *temporaryPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;foo.temp&quot;];
<a name="l00541"></a>00541 
<a name="l00542"></a>00542         [@&quot;&quot; writeToFile:temporaryPath atomically:NO encoding:NSUTF8StringEncoding error:NULL];
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *downloadPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;foo.txt&quot;];
<a name="l00545"></a>00545 
<a name="l00546"></a>00546         <span class="comment">// Download part of a large file that is returned after a redirect</span>
<a name="l00547"></a>00547         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url];
<a name="l00548"></a>00548         [request setTemporaryFileDownloadPath:temporaryPath];
<a name="l00549"></a>00549         [request setDownloadDestinationPath:downloadPath];
<a name="l00550"></a>00550         [request setAllowResumeForFileDownloads:YES];
<a name="l00551"></a>00551         [request setAllowCompressedResponse:NO];
<a name="l00552"></a>00552         [request setShouldAttemptPersistentConnection:NO];
<a name="l00553"></a>00553         [request startAsynchronous];
<a name="l00554"></a>00554 
<a name="l00555"></a>00555         <span class="comment">// Cancel the request as soon as it has downloaded 64KB</span>
<a name="l00556"></a>00556         <span class="keywordflow">while</span> (1) {
<a name="l00557"></a>00557                 sleep(0.5);
<a name="l00558"></a>00558                 <span class="keywordflow">if</span> ([request totalBytesRead] &gt; 32*1024) {
<a name="l00559"></a>00559                         [request cancel];
<a name="l00560"></a>00560                         <span class="keywordflow">break</span>;
<a name="l00561"></a>00561                 }
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563         NSNumber *fileSize =  [[[NSFileManager defaultManager] attributesOfItemAtPath:temporaryPath error:NULL] objectForKey:NSFileSize];
<a name="l00564"></a>00564         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> partialFileSize = [fileSize unsignedLongLongValue];
<a name="l00565"></a>00565         BOOL success = (partialFileSize &lt; 1036935);
<a name="l00566"></a>00566         GHAssertTrue(success,<span class="stringliteral">@&quot;Downloaded whole file too quickly, cannot proceed with this test&quot;</span>);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <span class="comment">// Resume the download</span>
<a name="l00570"></a>00570         request = [ASIHTTPRequest requestWithURL:url];
<a name="l00571"></a>00571         [request setTemporaryFileDownloadPath:temporaryPath];
<a name="l00572"></a>00572         [request setDownloadDestinationPath:downloadPath];
<a name="l00573"></a>00573         [request setAllowResumeForFileDownloads:YES];
<a name="l00574"></a>00574         [request setAllowCompressedResponse:NO];
<a name="l00575"></a>00575 
<a name="l00576"></a>00576         [request buildRequestHeaders];
<a name="l00577"></a>00577         success = ([request partialDownloadSize] == partialFileSize);
<a name="l00578"></a>00578         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to obtain correct partial dowload size&quot;</span>);
<a name="l00579"></a>00579         [request startAsynchronous];
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <span class="keywordflow">while</span> (1) {
<a name="l00582"></a>00582                 sleep(0.5);
<a name="l00583"></a>00583                 <span class="keywordflow">if</span> ([request isFinished]) {
<a name="l00584"></a>00584                         <span class="keywordflow">break</span>;
<a name="l00585"></a>00585                 }
<a name="l00586"></a>00586         }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         GHAssertNil([request error],<span class="stringliteral">@&quot;Request failed, cannot proceed with this test&quot;</span>);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         success = (![[request responseHeaders] objectForKey:@&quot;Content-Range&quot;]);
<a name="l00591"></a>00591         GHAssertTrue(success,<span class="stringliteral">@&quot;Got range header back, cannot proceed with this test&quot;</span>);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593         NSDictionary *attributes = [[NSFileManager defaultManager] attributesOfItemAtPath:downloadPath error:NULL];
<a name="l00594"></a>00594         fileSize =  [attributes objectForKey:NSFileSize];
<a name="l00595"></a>00595         success = ([fileSize intValue] == 1036935);
<a name="l00596"></a>00596         GHAssertTrue(success,<span class="stringliteral">@&quot;Downloaded file has wrong length&quot;</span>);
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         success = ([request partialDownloadSize] == 0);
<a name="l00599"></a>00599         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to reset download size&quot;</span>);
<a name="l00600"></a>00600 }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602 
<a name="l00603"></a>00603 - (void)testRedirectedResume
<a name="l00604"></a>00604 {
<a name="l00605"></a>00605         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(runRedirectedResume) withObject:nil waitUntilDone:YES];
<a name="l00606"></a>00606 }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 - (void)runRedirectedResume
<a name="l00609"></a>00609 {
<a name="l00610"></a>00610         NSURL *url = [NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect_resume&quot;];
<a name="l00611"></a>00611         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *temporaryPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;foo.temp&quot;];
<a name="l00612"></a>00612         
<a name="l00613"></a>00613         [@&quot;&quot; writeToFile:temporaryPath atomically:NO encoding:NSUTF8StringEncoding error:NULL];
<a name="l00614"></a>00614         
<a name="l00615"></a>00615         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *downloadPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;foo.txt&quot;];
<a name="l00616"></a>00616         
<a name="l00617"></a>00617         <span class="comment">// Download part of a large file that is returned after a redirect</span>
<a name="l00618"></a>00618         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url];
<a name="l00619"></a>00619         [request setTemporaryFileDownloadPath:temporaryPath];
<a name="l00620"></a>00620         [request setDownloadDestinationPath:downloadPath];
<a name="l00621"></a>00621         [request setAllowResumeForFileDownloads:YES];
<a name="l00622"></a>00622         [request setAllowCompressedResponse:NO];
<a name="l00623"></a>00623         [request startAsynchronous];
<a name="l00624"></a>00624         
<a name="l00625"></a>00625         <span class="comment">// Cancel the request as soon as it has downloaded 64KB</span>
<a name="l00626"></a>00626         <span class="keywordflow">while</span> (1) {
<a name="l00627"></a>00627                 [[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:0.5]];
<a name="l00628"></a>00628                 <span class="keywordflow">if</span> ([request totalBytesRead] &gt; 32*1024) {
<a name="l00629"></a>00629                         [request cancel];
<a name="l00630"></a>00630                         <span class="keywordflow">break</span>;
<a name="l00631"></a>00631                 }
<a name="l00632"></a>00632         }
<a name="l00633"></a>00633         NSNumber *fileSize =  [[[NSFileManager defaultManager] attributesOfItemAtPath:temporaryPath error:NULL] objectForKey:NSFileSize];
<a name="l00634"></a>00634         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> partialFileSize = [fileSize unsignedLongLongValue];
<a name="l00635"></a>00635         BOOL success = (partialFileSize &lt; 1036935);
<a name="l00636"></a>00636         GHAssertTrue(success,<span class="stringliteral">@&quot;Downloaded whole file too quickly, cannot proceed with this test&quot;</span>);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         <span class="comment">// Resume the download synchronously</span>
<a name="l00640"></a>00640         request = [ASIHTTPRequest requestWithURL:url];
<a name="l00641"></a>00641         [request setTemporaryFileDownloadPath:temporaryPath];
<a name="l00642"></a>00642         [request setDownloadDestinationPath:downloadPath];
<a name="l00643"></a>00643         [request setAllowResumeForFileDownloads:YES];
<a name="l00644"></a>00644         [request setAllowCompressedResponse:NO];
<a name="l00645"></a>00645         [request startSynchronous];
<a name="l00646"></a>00646         
<a name="l00647"></a>00647         fileSize =  [[[NSFileManager defaultManager] attributesOfItemAtPath:downloadPath error:NULL] objectForKey:NSFileSize];
<a name="l00648"></a>00648         success = ([fileSize intValue] == 1036935);
<a name="l00649"></a>00649         GHAssertTrue(success,<span class="stringliteral">@&quot;Downloaded file has wrong length&quot;</span>);
<a name="l00650"></a>00650         
<a name="l00651"></a>00651         success = [[[request requestHeaders] objectForKey:@&quot;Range&quot;] isEqualToString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;bytes=%llu-&quot;,partialFileSize]];
<a name="l00652"></a>00652         GHAssertTrue(success,<span class="stringliteral">@&quot;Restarted download when we should have resumed, or asked for the wrong segment of the file&quot;</span>);
<a name="l00653"></a>00653         
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 - (void)testUploadContentLength
<a name="l00657"></a>00657 {
<a name="l00658"></a>00658         <span class="comment">//This url will return the contents of the Content-Length request header</span>
<a name="l00659"></a>00659         NSURL *url = [NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/content-length&quot;];
<a name="l00660"></a>00660         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00661"></a>00661         [request setPostBody:[NSMutableData dataWithLength:1024*32]];
<a name="l00662"></a>00662         [request startSynchronous];
<a name="l00663"></a>00663         
<a name="l00664"></a>00664         BOOL success = ([[request responseString] isEqualToString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;%hu&quot;,(1024*32)]]);
<a name="l00665"></a>00665         GHAssertTrue(success,<span class="stringliteral">@&quot;Sent wrong content length&quot;</span>);
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668 - (void)testDownloadContentLength
<a name="l00669"></a>00669 {
<a name="l00670"></a>00670         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/i/logo.png&quot;] autorelease];
<a name="l00671"></a>00671         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00672"></a>00672         [request startSynchronous];
<a name="l00673"></a>00673         
<a name="l00674"></a>00674         BOOL success = ([request contentLength] == 27872);
<a name="l00675"></a>00675         GHAssertTrue(success,<span class="stringliteral">@&quot;Got wrong content length&quot;</span>);
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 - (void)testFileDownload
<a name="l00679"></a>00679 {
<a name="l00680"></a>00680         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *path = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;testimage.png&quot;];
<a name="l00681"></a>00681         
<a name="l00682"></a>00682         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/i/logo.png&quot;] autorelease];
<a name="l00683"></a>00683         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00684"></a>00684         [request setDownloadDestinationPath:path];
<a name="l00685"></a>00685         [request startSynchronous];
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 <span class="preprocessor">#if TARGET_OS_IPHONE</span>
<a name="l00688"></a>00688 <span class="preprocessor"></span>        UIImage *image = [[[UIImage alloc] initWithContentsOfFile:path] autorelease];
<a name="l00689"></a>00689 <span class="preprocessor">#else</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span>        NSImage *image = [[[NSImage alloc] initWithContentsOfFile:path] autorelease];   
<a name="l00691"></a>00691 <span class="preprocessor">#endif</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span>        
<a name="l00693"></a>00693         GHAssertNotNil(image,<span class="stringliteral">@&quot;Failed to download data to a file&quot;</span>);
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696 
<a name="l00697"></a>00697 - (void)testCompressedResponseDownloadToFile
<a name="l00698"></a>00698 {
<a name="l00699"></a>00699         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *path = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;testfile&quot;];
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/first&quot;] autorelease];
<a name="l00702"></a>00702         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00703"></a>00703         [request setDownloadDestinationPath:path];
<a name="l00704"></a>00704         [request startSynchronous];
<a name="l00705"></a>00705 
<a name="l00706"></a>00706         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *tempPath = [request temporaryFileDownloadPath];
<a name="l00707"></a>00707         GHAssertNil(tempPath,<span class="stringliteral">@&quot;Failed to clean up temporary download file&quot;</span>);            
<a name="l00708"></a>00708 
<a name="l00709"></a>00709         BOOL success = [[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:NULL] isEqualToString:@&quot;This is the expected content for the first string&quot;];
<a name="l00710"></a>00710         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to download data to a file&quot;</span>);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712         <span class="comment">// Now test with inflating the response on the fly</span>
<a name="l00713"></a>00713         NSError *error = nil;
<a name="l00714"></a>00714         [ASIHTTPRequest removeFileAtPath:path error:&amp;error];
<a name="l00715"></a>00715         <span class="keywordflow">if</span> (error) {
<a name="l00716"></a>00716                 GHFail(<span class="stringliteral">@&quot;Failed to remove file, cannot proceed with test&quot;</span>);
<a name="l00717"></a>00717         }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00720"></a>00720         [request setDownloadDestinationPath:path];
<a name="l00721"></a>00721         [request setShouldWaitToInflateCompressedResponses:NO];
<a name="l00722"></a>00722         [request startSynchronous];
<a name="l00723"></a>00723 
<a name="l00724"></a>00724         tempPath = [request temporaryFileDownloadPath];
<a name="l00725"></a>00725         GHAssertNil(tempPath,<span class="stringliteral">@&quot;Failed to clean up temporary download file&quot;</span>);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727         success = [[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:NULL] isEqualToString:@&quot;This is the expected content for the first string&quot;];
<a name="l00728"></a>00728         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to download data to a file&quot;</span>);
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731 - (void)request:(ASIHTTPRequest *)request didGetMoreData:(<a class="code" href="class_n_s_data.html" title="For hashing raw data.">NSData</a> *)data
<a name="l00732"></a>00732 {
<a name="l00733"></a>00733         [[<span class="keyword">self</span> responseData] appendData:data];
<a name="l00734"></a>00734 }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736 - (void)downloadFinished:(ASIHTTPRequest *)request
<a name="l00737"></a>00737 {
<a name="l00738"></a>00738         finished = YES;
<a name="l00739"></a>00739 }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 - (void)testCompressedResponseDelegateDataHandling
<a name="l00742"></a>00742 {
<a name="l00743"></a>00743         finished = NO;
<a name="l00744"></a>00744         [<span class="keyword">self</span> setResponseData:[NSMutableData data]];
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_hound_of_the_baskervilles.text&quot;] autorelease];
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00749"></a>00749         [request startSynchronous];
<a name="l00750"></a>00750 
<a name="l00751"></a>00751         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *response = [request responseString];
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="comment">// Now download again, using the delegate to handle the data</span>
<a name="l00754"></a>00754         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00755"></a>00755         [request setDelegate:self];
<a name="l00756"></a>00756         [request setDidReceiveDataSelector:@selector(request:didGetMoreData:)];
<a name="l00757"></a>00757         [request setDidFinishSelector:@selector(downloadFinished:)];
<a name="l00758"></a>00758         [request setShouldWaitToInflateCompressedResponses:NO];
<a name="l00759"></a>00759         [request startSynchronous];
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         <span class="keywordflow">while</span> (!finished) {
<a name="l00762"></a>00762                 sleep(1);
<a name="l00763"></a>00763         }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *delegateResponse = [[[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> alloc] initWithBytes:[responseData bytes] length:[responseData length] encoding:[request responseEncoding]] autorelease];
<a name="l00766"></a>00766         BOOL success = [delegateResponse isEqualToString:response];
<a name="l00767"></a>00767         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to correctly download the response using a delegate&quot;</span>);
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         <span class="comment">// Test again without compression</span>
<a name="l00770"></a>00770         finished = NO;
<a name="l00771"></a>00771         [<span class="keyword">self</span> setResponseData:[NSMutableData data]];
<a name="l00772"></a>00772 
<a name="l00773"></a>00773         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00774"></a>00774         [request setAllowCompressedResponse:NO];
<a name="l00775"></a>00775         [request startSynchronous];
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         response = [request responseString];
<a name="l00778"></a>00778 
<a name="l00779"></a>00779         <span class="comment">// Now download again, using the delegate to handle the data</span>
<a name="l00780"></a>00780         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00781"></a>00781         [request setDelegate:self];
<a name="l00782"></a>00782         [request setDidReceiveDataSelector:@selector(request:didGetMoreData:)];
<a name="l00783"></a>00783         [request setDidFinishSelector:@selector(downloadFinished:)];
<a name="l00784"></a>00784         [request setAllowCompressedResponse:NO];
<a name="l00785"></a>00785         [request startSynchronous];
<a name="l00786"></a>00786 
<a name="l00787"></a>00787         <span class="keywordflow">while</span> (!finished) {
<a name="l00788"></a>00788                 sleep(1);
<a name="l00789"></a>00789         }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         delegateResponse = [[[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> alloc] initWithBytes:[responseData bytes] length:[responseData length] encoding:[request responseEncoding]] autorelease];
<a name="l00792"></a>00792         success = [delegateResponse isEqualToString:response];
<a name="l00793"></a>00793         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to correctly download the response using a delegate&quot;</span>);
<a name="l00794"></a>00794 }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 
<a name="l00797"></a>00797 - (void)testDownloadProgress
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799         <span class="comment">// We run tests that measure progress on the main thread because otherwise we can&#39;t depend on the progress delegate being notified before we need to test it&#39;s working</span>
<a name="l00800"></a>00800         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(performDownloadProgressTest) withObject:nil waitUntilDone:YES];
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 - (void)performDownloadProgressTest
<a name="l00804"></a>00804 {
<a name="l00805"></a>00805         progress = 0;
<a name="l00806"></a>00806         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/i/logo.png&quot;] autorelease];
<a name="l00807"></a>00807         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00808"></a>00808         [request setDownloadProgressDelegate:self];
<a name="l00809"></a>00809         [request startSynchronous];
<a name="l00810"></a>00810 
<a name="l00811"></a>00811         BOOL success = (progress == 1.0);
<a name="l00812"></a>00812         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to properly increment download progress %f != 1.0&quot;</span>,progress);     
<a name="l00813"></a>00813         
<a name="l00814"></a>00814         progress = 0;
<a name="l00815"></a>00815         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel.txt&quot;]];
<a name="l00816"></a>00816         [request setDownloadProgressDelegate:self];
<a name="l00817"></a>00817         [request startAsynchronous];
<a name="l00818"></a>00818         
<a name="l00819"></a>00819         [[NSRunLoop currentRunLoop] runUntilDate:[NSDate dateWithTimeIntervalSinceNow:2]];
<a name="l00820"></a>00820         
<a name="l00821"></a>00821         success = (progress != 1.0);
<a name="l00822"></a>00822         GHAssertTrue(success,<span class="stringliteral">@&quot;Downloaded too quickly, cannot proceed with test&quot;</span>);      
<a name="l00823"></a>00823          
<a name="l00824"></a>00824         success = (progress &gt; 0);
<a name="l00825"></a>00825         GHAssertTrue(success,<span class="stringliteral">@&quot;Either downloaded too slowly, or progress is not being correctly updated&quot;</span>);               
<a name="l00826"></a>00826         
<a name="l00827"></a>00827         
<a name="l00828"></a>00828 }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 - (void)testUploadProgress
<a name="l00831"></a>00831 {
<a name="l00832"></a>00832         <span class="comment">// We run tests that measure progress on the main thread because otherwise we can&#39;t depend on the progress delegate being notified before we need to test it&#39;s working</span>
<a name="l00833"></a>00833         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(performUploadProgressTest) withObject:nil waitUntilDone:YES];       
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836 - (void)performUploadProgressTest
<a name="l00837"></a>00837 {
<a name="l00838"></a>00838         progress = 0;
<a name="l00839"></a>00839         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ignore&quot;]] autorelease];
<a name="l00840"></a>00840         [request setPostBody:(NSMutableData *)[@&quot;This is the request body&quot; dataUsingEncoding:NSUTF8StringEncoding]];
<a name="l00841"></a>00841         [request setUploadProgressDelegate:self];
<a name="l00842"></a>00842         [request startSynchronous];
<a name="l00843"></a>00843         
<a name="l00844"></a>00844         
<a name="l00845"></a>00845         BOOL success = (progress == 1.0);
<a name="l00846"></a>00846         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to properly increment upload progress %f != 1.0&quot;</span>,progress);       
<a name="l00847"></a>00847 }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 - (void)testPostBodyStreamedFromDisk
<a name="l00850"></a>00850 {
<a name="l00851"></a>00851         <span class="comment">// We run tests that measure progress on the main thread because otherwise we can&#39;t depend on the progress delegate being notified before we need to test it&#39;s working</span>
<a name="l00852"></a>00852         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(performPostBodyStreamedFromDiskTest) withObject:nil waitUntilDone:YES];
<a name="l00853"></a>00853         
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00856"></a>00856 - (void)performPostBodyStreamedFromDiskTest
<a name="l00857"></a>00857 {
<a name="l00858"></a>00858         NSURL *url = [NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/print_request_body&quot;];
<a name="l00859"></a>00859         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *requestBody = <span class="stringliteral">@&quot;This is the request body&quot;</span>;
<a name="l00860"></a>00860         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *requestContentPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;testfile.txt&quot;];
<a name="l00861"></a>00861         [[requestBody dataUsingEncoding:NSUTF8StringEncoding] writeToFile:requestContentPath atomically:NO];
<a name="l00862"></a>00862         
<a name="l00863"></a>00863         
<a name="l00864"></a>00864         <span class="comment">// Test using a user-specified file as the request body (useful for PUT)</span>
<a name="l00865"></a>00865         progress = 0;
<a name="l00866"></a>00866         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00867"></a>00867         [request setRequestMethod:@&quot;PUT&quot;];
<a name="l00868"></a>00868         [request setShouldStreamPostDataFromDisk:YES];
<a name="l00869"></a>00869         [request setUploadProgressDelegate:self];
<a name="l00870"></a>00870         [request setPostBodyFilePath:requestContentPath];
<a name="l00871"></a>00871         [request startSynchronous];
<a name="l00872"></a>00872         
<a name="l00873"></a>00873         BOOL success = (progress == 1.0);
<a name="l00874"></a>00874         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to properly increment upload progress %f != 1.0&quot;</span>,progress);
<a name="l00875"></a>00875         
<a name="l00876"></a>00876         success = [[request responseString] isEqualToString:requestBody];
<a name="l00877"></a>00877         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed upload the correct request body&quot;</span>);
<a name="l00878"></a>00878         
<a name="l00879"></a>00879         
<a name="l00880"></a>00880         <span class="comment">// Test building a request body by appending data</span>
<a name="l00881"></a>00881         progress = 0;
<a name="l00882"></a>00882         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00883"></a>00883         [request setShouldStreamPostDataFromDisk:YES];
<a name="l00884"></a>00884         [request setRequestMethod:@&quot;PUT&quot;];
<a name="l00885"></a>00885         [request setUploadProgressDelegate:self];
<a name="l00886"></a>00886         [request appendPostDataFromFile:requestContentPath];
<a name="l00887"></a>00887         [request startSynchronous];
<a name="l00888"></a>00888         
<a name="l00889"></a>00889         success = (progress == 1.0);
<a name="l00890"></a>00890         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to properly increment upload progress %f != 1.0&quot;</span>,progress);
<a name="l00891"></a>00891         
<a name="l00892"></a>00892         success = [[request responseString] isEqualToString:requestBody];
<a name="l00893"></a>00893         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed upload the correct request body&quot;</span>);                
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 - (void)testCookies
<a name="l00897"></a>00897 {
<a name="l00898"></a>00898         BOOL success;
<a name="l00899"></a>00899         
<a name="l00900"></a>00900         <span class="comment">// Set setting a cookie</span>
<a name="l00901"></a>00901         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/set_cookie&quot;] autorelease];
<a name="l00902"></a>00902         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00903"></a>00903         [request setUseCookiePersistence:YES];
<a name="l00904"></a>00904         [request startSynchronous];
<a name="l00905"></a>00905         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *html = [request responseString];
<a name="l00906"></a>00906         success = [html isEqualToString:@&quot;I have set a cookie&quot;];
<a name="l00907"></a>00907         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to set a cookie&quot;</span>);
<a name="l00908"></a>00908         
<a name="l00909"></a>00909         <span class="comment">// Test a cookie is stored in responseCookies</span>
<a name="l00910"></a>00910         NSArray *cookies = [request responseCookies];
<a name="l00911"></a>00911         GHAssertNotNil(cookies,<span class="stringliteral">@&quot;Failed to store cookie data in responseCookies&quot;</span>);
<a name="l00912"></a>00912         
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         <span class="comment">// Test the cookie contains the correct data</span>
<a name="l00915"></a>00915         NSHTTPCookie *cookie = nil;
<a name="l00916"></a>00916         BOOL foundCookie = NO;
<a name="l00917"></a>00917         <span class="keywordflow">for</span> (cookie in cookies) {
<a name="l00918"></a>00918                 <span class="keywordflow">if</span> ([[cookie name] isEqualToString:<span class="stringliteral">@&quot;ASIHTTPRequestTestCookie&quot;</span>]) {
<a name="l00919"></a>00919                         foundCookie = YES;
<a name="l00920"></a>00920                         success = [[cookie value] isEqualToString:@&quot;This+is+the+value&quot;];
<a name="l00921"></a>00921                         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to store the correct value for a cookie&quot;</span>);
<a name="l00922"></a>00922                         success = [[cookie domain] isEqualToString:@&quot;allseeing-i.com&quot;];
<a name="l00923"></a>00923                         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to store the correct domain for a cookie&quot;</span>);
<a name="l00924"></a>00924                         success = [[cookie path] isEqualToString:@&quot;/ASIHTTPRequest/tests&quot;];
<a name="l00925"></a>00925                         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to store the correct path for a cookie&quot;</span>);
<a name="l00926"></a>00926                         <span class="keywordflow">break</span>;
<a name="l00927"></a>00927                 }
<a name="l00928"></a>00928         }
<a name="l00929"></a>00929         GHAssertTrue(foundCookie,<span class="stringliteral">@&quot;Failed store a particular cookie - can&#39;t continue with the rest of the tests&quot;</span>);
<a name="l00930"></a>00930         
<a name="l00931"></a>00931         <span class="keywordflow">if</span> (!foundCookie) {
<a name="l00932"></a>00932                 <span class="keywordflow">return</span>;
<a name="l00933"></a>00933         }
<a name="l00934"></a>00934         <span class="comment">// Test a cookie is presented when manually added to the request</span>
<a name="l00935"></a>00935         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/read_cookie&quot;] autorelease];
<a name="l00936"></a>00936         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00937"></a>00937         [request setUseCookiePersistence:NO];
<a name="l00938"></a>00938         [request setRequestCookies:[NSMutableArray arrayWithObject:cookie]];
<a name="l00939"></a>00939         [request startSynchronous];
<a name="l00940"></a>00940         html = [request responseString];
<a name="l00941"></a>00941         success = [html isEqualToString:@&quot;I have &#39;This is the value&#39; as the value of &#39;ASIHTTPRequestTestCookie&#39;&quot;];
<a name="l00942"></a>00942         GHAssertTrue(success,<span class="stringliteral">@&quot;Cookie not presented to the server with cookie persistence OFF&quot;</span>);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944         <span class="comment">// Test a cookie is presented from the persistent store</span>
<a name="l00945"></a>00945         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/read_cookie&quot;] autorelease];
<a name="l00946"></a>00946         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00947"></a>00947         [request setUseCookiePersistence:YES];
<a name="l00948"></a>00948         [request startSynchronous];
<a name="l00949"></a>00949         html = [request responseString];
<a name="l00950"></a>00950         success = [html isEqualToString:@&quot;I have &#39;This is the value&#39; as the value of &#39;ASIHTTPRequestTestCookie&#39;&quot;];
<a name="l00951"></a>00951         GHAssertTrue(success,<span class="stringliteral">@&quot;Cookie not presented to the server with cookie persistence ON&quot;</span>);
<a name="l00952"></a>00952         
<a name="l00953"></a>00953         <span class="comment">// Test removing a cookie</span>
<a name="l00954"></a>00954         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/remove_cookie&quot;] autorelease];
<a name="l00955"></a>00955         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00956"></a>00956         [request startSynchronous];
<a name="l00957"></a>00957         html = [request responseString];
<a name="l00958"></a>00958         success = [html isEqualToString:@&quot;I have removed a cookie&quot;];
<a name="l00959"></a>00959         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to remove a cookie&quot;</span>);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         <span class="comment">// Test making sure cookie was properly removed</span>
<a name="l00962"></a>00962         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/read_cookie&quot;] autorelease];
<a name="l00963"></a>00963         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00964"></a>00964         [request startSynchronous];
<a name="l00965"></a>00965         html = [request responseString];
<a name="l00966"></a>00966         success = [html isEqualToString:@&quot;No cookie exists&quot;];
<a name="l00967"></a>00967         GHAssertTrue(success,<span class="stringliteral">@&quot;Cookie presented to the server when it should have been removed&quot;</span>);
<a name="l00968"></a>00968         
<a name="l00969"></a>00969         <span class="comment">// Test setting a custom cookie works</span>
<a name="l00970"></a>00970         NSDictionary *cookieProperties = [[[NSMutableDictionary alloc] init] autorelease];
<a name="l00971"></a>00971         
<a name="l00972"></a>00972         <span class="comment">// We&#39;ll add a line break to our cookie value to test it gets correctly encoded</span>
<a name="l00973"></a>00973         [cookieProperties setValue:@&quot;Test%0D%0AValue&quot; forKey:NSHTTPCookieValue];
<a name="l00974"></a>00974         [cookieProperties setValue:@&quot;ASIHTTPRequestTestCookie&quot; forKey:NSHTTPCookieName];
<a name="l00975"></a>00975         [cookieProperties setValue:@&quot;allseeing-i.com&quot; forKey:NSHTTPCookieDomain];
<a name="l00976"></a>00976         [cookieProperties setValue:[NSDate dateWithTimeIntervalSinceNow:60*60*4] forKey:NSHTTPCookieExpires];
<a name="l00977"></a>00977         [cookieProperties setValue:@&quot;/ASIHTTPRequest/tests&quot; forKey:NSHTTPCookiePath];
<a name="l00978"></a>00978         cookie = [[[NSHTTPCookie alloc] initWithProperties:cookieProperties] autorelease];
<a name="l00979"></a>00979         
<a name="l00980"></a>00980         GHAssertNotNil(cookie,<span class="stringliteral">@&quot;Failed to create a cookie - cookie value was not correctly encoded?&quot;</span>);
<a name="l00981"></a>00981 
<a name="l00982"></a>00982         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/read_cookie&quot;] autorelease];
<a name="l00983"></a>00983         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l00984"></a>00984         [request setUseCookiePersistence:NO];
<a name="l00985"></a>00985         [request setRequestCookies:[NSMutableArray arrayWithObject:cookie]];
<a name="l00986"></a>00986         [request startSynchronous];
<a name="l00987"></a>00987         html = [request responseString];
<a name="l00988"></a>00988         success = [html isEqualToString:@&quot;I have &#39;Test\r\nValue&#39; as the value of &#39;ASIHTTPRequestTestCookie&#39;&quot;];
<a name="l00989"></a>00989         GHAssertTrue(success,<span class="stringliteral">@&quot;Custom cookie not presented to the server with cookie persistence OFF&quot;</span>);
<a name="l00990"></a>00990         
<a name="l00991"></a>00991 
<a name="l00992"></a>00992         <span class="comment">// Test removing all cookies works</span>
<a name="l00993"></a>00993         [ASIHTTPRequest clearSession];
<a name="l00994"></a>00994         NSArray *sessionCookies = [ASIHTTPRequest sessionCookies];
<a name="l00995"></a>00995         success = ([sessionCookies count] == 0);
<a name="l00996"></a>00996         GHAssertTrue(success,<span class="stringliteral">@&quot;Cookies not removed&quot;</span>);
<a name="l00997"></a>00997 
<a name="l00998"></a>00998         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/read_cookie&quot;] autorelease];
<a name="l00999"></a>00999         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01000"></a>01000         [request setUseCookiePersistence:YES];
<a name="l01001"></a>01001         [request startSynchronous];
<a name="l01002"></a>01002         html = [request responseString];
<a name="l01003"></a>01003         success = [html isEqualToString:@&quot;No cookie exists&quot;];
<a name="l01004"></a>01004         GHAssertTrue(success,<span class="stringliteral">@&quot;Cookie presented to the server when it should have been removed&quot;</span>);
<a name="l01005"></a>01005         
<a name="l01006"></a>01006         <span class="comment">// Test fetching cookies for a relative url - fixes a problem where urls created with URLWithString:relativeToURL: wouldn&#39;t always read cookies from the persistent store</span>
<a name="l01007"></a>01007         [ASIHTTPRequest clearSession];
<a name="l01008"></a>01008         
<a name="l01009"></a>01009         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/set_cookie&quot;] autorelease];
<a name="l01010"></a>01010         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01011"></a>01011         [request setUseCookiePersistence:YES];
<a name="l01012"></a>01012         [request setUseSessionPersistence:NO];
<a name="l01013"></a>01013         [request startSynchronous];
<a name="l01014"></a>01014         
<a name="l01015"></a>01015         NSURL *originalURL = [NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/&quot;];
<a name="l01016"></a>01016         url = [NSURL URLWithString:@&quot;read_cookie&quot; relativeToURL:originalURL];
<a name="l01017"></a>01017         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01018"></a>01018         [request setUseCookiePersistence:YES];
<a name="l01019"></a>01019         [request setUseSessionPersistence:NO];
<a name="l01020"></a>01020         [request startSynchronous];
<a name="l01021"></a>01021         html = [request responseString];
<a name="l01022"></a>01022         NSLog(<span class="stringliteral">@&quot;%@&quot;</span>,html);
<a name="l01023"></a>01023         success = [html isEqualToString:@&quot;I have &#39;This is the value&#39; as the value of &#39;ASIHTTPRequestTestCookie&#39;&quot;];
<a name="l01024"></a>01024         GHAssertTrue(success,<span class="stringliteral">@&quot;Custom cookie not presented to the server with cookie persistence OFF&quot;</span>);
<a name="l01025"></a>01025         
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 <span class="comment">// Test fix for a crash if you tried to remove credentials that didn&#39;t exist</span>
<a name="l01029"></a>01029 - (void)testRemoveCredentialsFromKeychain
<a name="l01030"></a>01030 {
<a name="l01031"></a>01031         [ASIHTTPRequest removeCredentialsForHost:@&quot;apple.com&quot; port:0 protocol:@&quot;http&quot; realm:@&quot;Nothing to see here&quot;];
<a name="l01032"></a>01032         [ASIHTTPRequest removeCredentialsForProxy:@&quot;apple.com&quot; port:0 realm:@&quot;Nothing to see here&quot;];
<a name="l01033"></a>01033         
<a name="l01034"></a>01034 }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036 - (void)testPreserveResponseWhenDownloadComplete
<a name="l01037"></a>01037 {
<a name="l01038"></a>01038         NSURL *url = [NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/basic-authentication&quot;];
<a name="l01039"></a>01039         ASIHTTPRequest *request;
<a name="l01040"></a>01040         BOOL success;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042         request = [ASIHTTPRequest requestWithURL:url];
<a name="l01043"></a>01043         [request startSynchronous];
<a name="l01044"></a>01044 
<a name="l01045"></a>01045         success = ([[request responseString] length]);
<a name="l01046"></a>01046         GHAssertTrue(success,<span class="stringliteral">@&quot;Request removed the response body when we encountered an error, even though the download was complete&quot;</span>);
<a name="l01047"></a>01047 
<a name="l01048"></a>01048         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *downloadPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;test.txt&quot;];
<a name="l01049"></a>01049         <span class="keywordflow">if</span> ([[NSFileManager defaultManager] fileExistsAtPath:downloadPath]) {
<a name="l01050"></a>01050                 [[NSFileManager defaultManager] removeItemAtPath:downloadPath error:NULL];
<a name="l01051"></a>01051         }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053         request = [ASIHTTPRequest requestWithURL:url];
<a name="l01054"></a>01054         [request setDownloadDestinationPath:downloadPath];
<a name="l01055"></a>01055         [request startSynchronous];
<a name="l01056"></a>01056 
<a name="l01057"></a>01057         success = ([[[NSFileManager defaultManager] attributesOfItemAtPath:downloadPath error:NULL] fileSize]);
<a name="l01058"></a>01058         GHAssertTrue(success,<span class="stringliteral">@&quot;Request removed or failed to copy the response to downloadDestinationPath&quot;</span>);
<a name="l01059"></a>01059 }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061 - (void)testBasicAuthentication
<a name="l01062"></a>01062 {
<a name="l01063"></a>01063         [ASIHTTPRequest removeCredentialsForHost:@&quot;allseeing-i.com&quot; port:0 protocol:@&quot;http&quot; realm:@&quot;SECRET_STUFF&quot;];
<a name="l01064"></a>01064         [ASIHTTPRequest clearSession];
<a name="l01065"></a>01065 
<a name="l01066"></a>01066         NSURL *url = [NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/basic-authentication&quot;];
<a name="l01067"></a>01067         ASIHTTPRequest *request;
<a name="l01068"></a>01068         BOOL success;
<a name="l01069"></a>01069         NSError *err;
<a name="l01070"></a>01070         
<a name="l01071"></a>01071         <span class="comment">// Test authentication needed when no credentials supplied</span>
<a name="l01072"></a>01072         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01073"></a>01073         [request setUseKeychainPersistence:NO];
<a name="l01074"></a>01074         [request startSynchronous];
<a name="l01075"></a>01075         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01076"></a>01076         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to generate permission denied error with no credentials&quot;</span>);
<a name="l01077"></a>01077 
<a name="l01078"></a>01078         <span class="comment">// Test wrong credentials supplied</span>
<a name="l01079"></a>01079         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01080"></a>01080         [request setUseKeychainPersistence:NO];
<a name="l01081"></a>01081         [request setUsername:@&quot;wrong&quot;];
<a name="l01082"></a>01082         [request setPassword:@&quot;wrong&quot;];
<a name="l01083"></a>01083         [request startSynchronous];
<a name="l01084"></a>01084         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01085"></a>01085         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to generate permission denied error with wrong credentials&quot;</span>);
<a name="l01086"></a>01086         
<a name="l01087"></a>01087         <span class="comment">// Test correct credentials supplied</span>
<a name="l01088"></a>01088         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01089"></a>01089         [request setUseSessionPersistence:YES];
<a name="l01090"></a>01090         [request setUseKeychainPersistence:YES];
<a name="l01091"></a>01091         [request setShouldPresentCredentialsBeforeChallenge:NO];
<a name="l01092"></a>01092         [request setUsername:@&quot;secret_username&quot;];
<a name="l01093"></a>01093         [request setPassword:@&quot;secret_password&quot;];
<a name="l01094"></a>01094         [request startSynchronous];
<a name="l01095"></a>01095         err = [request error];
<a name="l01096"></a>01096         GHAssertNil(err,<span class="stringliteral">@&quot;Failed to supply correct username and password&quot;</span>);
<a name="l01097"></a>01097         
<a name="l01098"></a>01098         <span class="comment">// Ensure credentials are not reused</span>
<a name="l01099"></a>01099         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01100"></a>01100         [request setUseSessionPersistence:NO];
<a name="l01101"></a>01101         [request setUseKeychainPersistence:NO];
<a name="l01102"></a>01102         [request startSynchronous];
<a name="l01103"></a>01103         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01104"></a>01104         GHAssertTrue(success,<span class="stringliteral">@&quot;Reused credentials when we shouldn&#39;t have&quot;</span>);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106         <span class="comment">// Ensure credentials stored in the session are reused</span>
<a name="l01107"></a>01107         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01108"></a>01108         [request setUseSessionPersistence:YES];
<a name="l01109"></a>01109         [request setUseKeychainPersistence:NO];
<a name="l01110"></a>01110         [request startSynchronous];
<a name="l01111"></a>01111         err = [request error];
<a name="l01112"></a>01112         GHAssertNil(err,<span class="stringliteral">@&quot;Failed to reuse credentials&quot;</span>);
<a name="l01113"></a>01113         
<a name="l01114"></a>01114         <span class="comment">// Ensure new credentials are used in place of those in the session</span>
<a name="l01115"></a>01115         request = [[[ASIHTTPRequest alloc] initWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/basic-authentication-new-credentials&quot;]] autorelease];
<a name="l01116"></a>01116         [request setUsername:@&quot;secret_username_2&quot;];
<a name="l01117"></a>01117         [request setPassword:@&quot;secret_password_2&quot;];
<a name="l01118"></a>01118         [request setUseSessionPersistence:YES];
<a name="l01119"></a>01119         [request setUseKeychainPersistence:NO];
<a name="l01120"></a>01120         [request startSynchronous];
<a name="l01121"></a>01121         err = [request error];
<a name="l01122"></a>01122         GHAssertNil(err,<span class="stringliteral">@&quot;Failed to reuse credentials&quot;</span>);
<a name="l01123"></a>01123         
<a name="l01124"></a>01124         [ASIHTTPRequest clearSession];
<a name="l01125"></a>01125         
<a name="l01126"></a>01126         <span class="comment">// Ensure credentials stored in the session were wiped</span>
<a name="l01127"></a>01127         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01128"></a>01128         [request setUseKeychainPersistence:NO];
<a name="l01129"></a>01129         [request startSynchronous];
<a name="l01130"></a>01130         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01131"></a>01131         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to clear credentials&quot;</span>);
<a name="l01132"></a>01132         
<a name="l01133"></a>01133         <span class="comment">// Ensure credentials stored in the keychain are reused</span>
<a name="l01134"></a>01134         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01135"></a>01135         [request setUseKeychainPersistence:YES];
<a name="l01136"></a>01136         [request startSynchronous];
<a name="l01137"></a>01137         err = [request error];
<a name="l01138"></a>01138         GHAssertNil(err,<span class="stringliteral">@&quot;Failed to use stored credentials&quot;</span>);
<a name="l01139"></a>01139         
<a name="l01140"></a>01140         [ASIHTTPRequest removeCredentialsForHost:@&quot;allseeing-i.com&quot; port:0 protocol:@&quot;http&quot; realm:@&quot;SECRET_STUFF&quot;];
<a name="l01141"></a>01141         
<a name="l01142"></a>01142         <span class="comment">// Ensure credentials stored in the keychain were wiped</span>
<a name="l01143"></a>01143         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01144"></a>01144         [request setUseKeychainPersistence:YES];
<a name="l01145"></a>01145         [request setUseSessionPersistence:NO];
<a name="l01146"></a>01146         [request startSynchronous];
<a name="l01147"></a>01147         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01148"></a>01148         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to clear credentials&quot;</span>);
<a name="l01149"></a>01149         
<a name="l01150"></a>01150         <span class="comment">// Tests shouldPresentCredentialsBeforeChallenge with credentials stored in the session</span>
<a name="l01151"></a>01151         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01152"></a>01152         [request setUseSessionPersistence:YES];
<a name="l01153"></a>01153         [request startSynchronous];
<a name="l01154"></a>01154         success = [request authenticationRetryCount] == 0;
<a name="l01155"></a>01155         GHAssertTrue(success,<span class="stringliteral">@&quot;Didn&#39;t supply credentials before being asked for them when talking to the same server with shouldPresentCredentialsBeforeChallenge == YES&quot;</span>);
<a name="l01156"></a>01156         
<a name="l01157"></a>01157         <span class="comment">// Ensure credentials stored in the session were not presented to the server before it asked for them</span>
<a name="l01158"></a>01158         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01159"></a>01159         [request setUseSessionPersistence:YES];
<a name="l01160"></a>01160         [request setShouldPresentCredentialsBeforeChallenge:NO];
<a name="l01161"></a>01161         [request startSynchronous];
<a name="l01162"></a>01162         success = [request authenticationRetryCount] == 1;
<a name="l01163"></a>01163         GHAssertTrue(success,<span class="stringliteral">@&quot;Supplied session credentials before being asked for them&quot;</span>);      
<a name="l01164"></a>01164         
<a name="l01165"></a>01165         [ASIHTTPRequest clearSession];
<a name="l01166"></a>01166         
<a name="l01167"></a>01167         <span class="comment">// Test credentials set on the request are not sent before the server asks for them unless they are cached credentials from a previous request to this server</span>
<a name="l01168"></a>01168         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01169"></a>01169         [request setUseSessionPersistence:NO];
<a name="l01170"></a>01170         [request setUsername:@&quot;secret_username&quot;];
<a name="l01171"></a>01171         [request setPassword:@&quot;secret_password&quot;];
<a name="l01172"></a>01172         [request setShouldPresentCredentialsBeforeChallenge:YES];
<a name="l01173"></a>01173         [request startSynchronous];
<a name="l01174"></a>01174         BOOL fail = [request authenticationRetryCount] == 0;
<a name="l01175"></a>01175         GHAssertFalse(fail,<span class="stringliteral">@&quot;Sent Basic credentials even though request did not have kCFHTTPAuthenticationSchemeBasic set as authenticationScheme.&quot;</span>);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177         <span class="comment">// Test basic credentials set on the request are sent before the server asks for them if we&#39;ve explictly set the authentication scheme to basic</span>
<a name="l01178"></a>01178         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01179"></a>01179         [request setUseSessionPersistence:NO];
<a name="l01180"></a>01180         [request setUsername:@&quot;secret_username&quot;];
<a name="l01181"></a>01181         [request setPassword:@&quot;secret_password&quot;];
<a name="l01182"></a>01182         [request setShouldPresentCredentialsBeforeChallenge:YES];
<a name="l01183"></a>01183         [request setAuthenticationScheme:(NSString *)kCFHTTPAuthenticationSchemeBasic];
<a name="l01184"></a>01184         [request startSynchronous];
<a name="l01185"></a>01185         success = [request authenticationRetryCount] == 0;
<a name="l01186"></a>01186         GHAssertTrue(success,<span class="stringliteral">@&quot;Didn&#39;t supply credentials before being asked for them, even though they were set on the request and shouldPresentCredentialsBeforeChallenge == YES&quot;</span>);
<a name="l01187"></a>01187         
<a name="l01188"></a>01188         <span class="comment">// Test credentials set on the request aren&#39;t sent before the server asks for them</span>
<a name="l01189"></a>01189         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01190"></a>01190         [request setUseSessionPersistence:NO];
<a name="l01191"></a>01191         [request setUsername:@&quot;secret_username&quot;];
<a name="l01192"></a>01192         [request setPassword:@&quot;secret_password&quot;];
<a name="l01193"></a>01193         [request setShouldPresentCredentialsBeforeChallenge:NO];
<a name="l01194"></a>01194         [request startSynchronous];
<a name="l01195"></a>01195         success = [request authenticationRetryCount] == 1;
<a name="l01196"></a>01196         GHAssertTrue(success,<span class="stringliteral">@&quot;Supplied request credentials before being asked for them&quot;</span>);      
<a name="l01197"></a>01197         
<a name="l01198"></a>01198         
<a name="l01199"></a>01199         <span class="comment">// Test credentials presented before a challenge are stored in the session store</span>
<a name="l01200"></a>01200         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01201"></a>01201         [request setUsername:@&quot;secret_username&quot;];
<a name="l01202"></a>01202         [request setPassword:@&quot;secret_password&quot;];
<a name="l01203"></a>01203         [request setShouldPresentCredentialsBeforeChallenge:YES];
<a name="l01204"></a>01204         [request startSynchronous];
<a name="l01205"></a>01205         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01206"></a>01206         [request startSynchronous];
<a name="l01207"></a>01207         err = [request error];
<a name="l01208"></a>01208         GHAssertNil(err,<span class="stringliteral">@&quot;Failed to use stored credentials&quot;</span>);   
<a name="l01209"></a>01209         
<a name="l01210"></a>01210         
<a name="l01211"></a>01211         <span class="comment">// Ok, now let&#39;s test on a different server to sanity check that the credentials from out previous requests are not being used</span>
<a name="l01212"></a>01212         url = [NSURL URLWithString:@&quot;https://selfsigned.allseeing-i.com/ASIHTTPRequest/tests/basic-authentication&quot;];
<a name="l01213"></a>01213         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01214"></a>01214         [request setUseSessionPersistence:YES];
<a name="l01215"></a>01215         [request setUseKeychainPersistence:NO];
<a name="l01216"></a>01216         [request setValidatesSecureCertificate:NO];
<a name="l01217"></a>01217         [request startSynchronous];
<a name="l01218"></a>01218         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01219"></a>01219         GHAssertTrue(success,<span class="stringliteral">@&quot;Reused credentials when we shouldn&#39;t have&quot;</span>);     
<a name="l01220"></a>01220         
<a name="l01221"></a>01221 }
<a name="l01222"></a>01222 
<a name="l01223"></a>01223 
<a name="l01224"></a>01224 
<a name="l01225"></a>01225 - (void)testDigestAuthentication
<a name="l01226"></a>01226 {
<a name="l01227"></a>01227         [ASIHTTPRequest removeCredentialsForHost:@&quot;allseeing-i.com&quot; port:0 protocol:@&quot;http&quot; realm:@&quot;Keep out&quot;];
<a name="l01228"></a>01228         [ASIHTTPRequest clearSession];
<a name="l01229"></a>01229         
<a name="l01230"></a>01230         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/digest-authentication&quot;] autorelease];
<a name="l01231"></a>01231         ASIHTTPRequest *request;
<a name="l01232"></a>01232         BOOL success;
<a name="l01233"></a>01233         NSError *err;
<a name="l01234"></a>01234         
<a name="l01235"></a>01235         <span class="comment">// Test authentication needed when no credentials supplied</span>
<a name="l01236"></a>01236         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01237"></a>01237         [request setUseKeychainPersistence:NO];
<a name="l01238"></a>01238         [request startSynchronous];
<a name="l01239"></a>01239         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01240"></a>01240         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to generate permission denied error with no credentials&quot;</span>);
<a name="l01241"></a>01241         
<a name="l01242"></a>01242         <span class="comment">// Test wrong credentials supplied</span>
<a name="l01243"></a>01243         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01244"></a>01244         [request setUseKeychainPersistence:NO];
<a name="l01245"></a>01245         [request setUsername:@&quot;wrong&quot;];
<a name="l01246"></a>01246         [request setPassword:@&quot;wrong&quot;];
<a name="l01247"></a>01247         [request startSynchronous];
<a name="l01248"></a>01248         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01249"></a>01249         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to generate permission denied error with wrong credentials&quot;</span>);
<a name="l01250"></a>01250         
<a name="l01251"></a>01251         <span class="comment">// Test correct credentials supplied</span>
<a name="l01252"></a>01252         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01253"></a>01253         [request setUseSessionPersistence:YES];
<a name="l01254"></a>01254         [request setUseKeychainPersistence:YES];
<a name="l01255"></a>01255         [request setUsername:@&quot;secret_username&quot;];
<a name="l01256"></a>01256         [request setPassword:@&quot;secret_password&quot;];
<a name="l01257"></a>01257         [request startSynchronous];
<a name="l01258"></a>01258         err = [request error];
<a name="l01259"></a>01259         GHAssertNil(err,<span class="stringliteral">@&quot;Failed to supply correct username and password&quot;</span>);
<a name="l01260"></a>01260         
<a name="l01261"></a>01261         <span class="comment">// Ensure credentials are not reused</span>
<a name="l01262"></a>01262         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01263"></a>01263         [request setUseSessionPersistence:NO];
<a name="l01264"></a>01264         [request setUseKeychainPersistence:NO];
<a name="l01265"></a>01265         [request startSynchronous];
<a name="l01266"></a>01266         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01267"></a>01267         GHAssertTrue(success,<span class="stringliteral">@&quot;Reused credentials when we shouldn&#39;t have&quot;</span>);
<a name="l01268"></a>01268         
<a name="l01269"></a>01269         <span class="comment">// Ensure credentials stored in the session are reused</span>
<a name="l01270"></a>01270         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01271"></a>01271         [request setUseSessionPersistence:YES];
<a name="l01272"></a>01272         [request setUseKeychainPersistence:NO];
<a name="l01273"></a>01273         [request startSynchronous];
<a name="l01274"></a>01274         err = [request error];
<a name="l01275"></a>01275         GHAssertNil(err,<span class="stringliteral">@&quot;Failed to reuse credentials&quot;</span>);
<a name="l01276"></a>01276         
<a name="l01277"></a>01277         [ASIHTTPRequest clearSession];
<a name="l01278"></a>01278         
<a name="l01279"></a>01279         <span class="comment">// Ensure credentials stored in the session were wiped</span>
<a name="l01280"></a>01280         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01281"></a>01281         [request setUseKeychainPersistence:NO];
<a name="l01282"></a>01282         [request startSynchronous];
<a name="l01283"></a>01283         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01284"></a>01284         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to clear credentials&quot;</span>);
<a name="l01285"></a>01285         
<a name="l01286"></a>01286         <span class="comment">// Ensure credentials stored in the keychain are reused</span>
<a name="l01287"></a>01287         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01288"></a>01288         [request setUseKeychainPersistence:YES];
<a name="l01289"></a>01289         [request startSynchronous];
<a name="l01290"></a>01290         err = [request error];
<a name="l01291"></a>01291         GHAssertNil(err,<span class="stringliteral">@&quot;Failed to reuse credentials&quot;</span>);
<a name="l01292"></a>01292         
<a name="l01293"></a>01293         [ASIHTTPRequest removeCredentialsForHost:@&quot;allseeing-i.com&quot; port:0 protocol:@&quot;http&quot; realm:@&quot;Keep out&quot;];
<a name="l01294"></a>01294         
<a name="l01295"></a>01295         <span class="comment">// Ensure credentials stored in the keychain were wiped</span>
<a name="l01296"></a>01296         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01297"></a>01297         [request setUseKeychainPersistence:YES];
<a name="l01298"></a>01298         [request setUseSessionPersistence:NO];
<a name="l01299"></a>01299         [request startSynchronous];
<a name="l01300"></a>01300         success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01301"></a>01301         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to clear credentials&quot;</span>);   
<a name="l01302"></a>01302         
<a name="l01303"></a>01303         
<a name="l01304"></a>01304         <span class="comment">// Test credentials set on the request are sent before the server asks for them</span>
<a name="l01305"></a>01305         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01306"></a>01306         [request setUseSessionPersistence:YES];
<a name="l01307"></a>01307         [request setShouldPresentCredentialsBeforeChallenge:YES];
<a name="l01308"></a>01308         [request startSynchronous];
<a name="l01309"></a>01309         success = [request authenticationRetryCount] == 0;
<a name="l01310"></a>01310         GHAssertTrue(success,<span class="stringliteral">@&quot;Didn&#39;t supply credentials before being asked for them, even though they were set in the session and shouldPresentCredentialsBeforeChallenge == YES&quot;</span>);    
<a name="l01311"></a>01311         
<a name="l01312"></a>01312 }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314 - (void)testNTLMHandshake
<a name="l01315"></a>01315 {
<a name="l01316"></a>01316         <span class="comment">// This test connects to a script that masquerades as an NTLM server</span>
<a name="l01317"></a>01317         <span class="comment">// It tests that the handshake seems sane, but doesn&#39;t actually authenticate</span>
<a name="l01318"></a>01318         
<a name="l01319"></a>01319         [ASIHTTPRequest clearSession];
<a name="l01320"></a>01320         
<a name="l01321"></a>01321         NSURL *url = [NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/pretend-ntlm-handshake&quot;];
<a name="l01322"></a>01322         
<a name="l01323"></a>01323         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url];
<a name="l01324"></a>01324         [request setUseKeychainPersistence:NO];
<a name="l01325"></a>01325         [request setUseSessionPersistence:NO];
<a name="l01326"></a>01326         [request startSynchronous];
<a name="l01327"></a>01327         BOOL success = [[request error] code] == ASIAuthenticationErrorType;
<a name="l01328"></a>01328         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to generate permission denied error with no credentials&quot;</span>);
<a name="l01329"></a>01329 
<a name="l01330"></a>01330 
<a name="l01331"></a>01331         request = [ASIHTTPRequest requestWithURL:url];
<a name="l01332"></a>01332         [request setUseSessionPersistence:YES];
<a name="l01333"></a>01333         [request setUseKeychainPersistence:NO];
<a name="l01334"></a>01334         [request setUsername:@&quot;king&quot;];
<a name="l01335"></a>01335         [request setPassword:@&quot;fink&quot;];
<a name="l01336"></a>01336         [request setDomain:@&quot;Castle.Kingdom&quot;];
<a name="l01337"></a>01337         [request startSynchronous];
<a name="l01338"></a>01338 
<a name="l01339"></a>01339         GHAssertNil([request error],<span class="stringliteral">@&quot;Got an error when credentials were supplied&quot;</span>);
<a name="l01340"></a>01340         
<a name="l01341"></a>01341         <span class="comment">// NSProcessInfo returns a lower case string for host name, while CFNetwork will send a mixed case string for host name, so we&#39;ll compare by lowercasing everything</span>
<a name="l01342"></a>01342         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *hostName = [[NSProcessInfo processInfo] hostName];
<a name="l01343"></a>01343         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *expectedResponse = [[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithFormat:@&quot;You are %@ from %@/%@&quot;,@&quot;king&quot;,@&quot;Castle.Kingdom&quot;,hostName] lowercaseString];
<a name="l01344"></a>01344         success = [[[request responseString] lowercaseString] isEqualToString:expectedResponse];
<a name="l01345"></a>01345         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to send credentials correctly? (Expected: &#39;%@&#39;, got &#39;%@&#39;)&quot;</span>,expectedResponse,[[request responseString] lowercaseString]);
<a name="l01346"></a>01346 }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348 - (void)testCompressedResponse
<a name="l01349"></a>01349 {
<a name="l01350"></a>01350         <span class="comment">// allseeing-i.com does not gzip png images</span>
<a name="l01351"></a>01351         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/i/logo.png&quot;] autorelease];
<a name="l01352"></a>01352         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01353"></a>01353         [request startSynchronous];
<a name="l01354"></a>01354         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *encoding = [[request responseHeaders] objectForKey:@&quot;Content-Encoding&quot;];
<a name="l01355"></a>01355         BOOL success = (!encoding || [encoding rangeOfString:@&quot;gzip&quot;].location != NSNotFound);
<a name="l01356"></a>01356         GHAssertTrue(success,<span class="stringliteral">@&quot;Got incorrect request headers from server&quot;</span>);
<a name="l01357"></a>01357 
<a name="l01358"></a>01358         success = ([request rawResponseData] == [request responseData]);
<a name="l01359"></a>01359         GHAssertTrue(success,<span class="stringliteral">@&quot;Attempted to uncompress data that was not compressed&quot;</span>);  
<a name="l01360"></a>01360 
<a name="l01361"></a>01361         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/first&quot;] autorelease];
<a name="l01362"></a>01362         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01363"></a>01363         [request startSynchronous];
<a name="l01364"></a>01364         success = ([request rawResponseData] != [request responseData]);
<a name="l01365"></a>01365         GHAssertTrue(success,<span class="stringliteral">@&quot;Uncompressed data is the same as compressed data&quot;</span>);      
<a name="l01366"></a>01366 
<a name="l01367"></a>01367         success = [[request responseString] isEqualToString:@&quot;This is the expected content for the first string&quot;];
<a name="l01368"></a>01368         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to decompress data correctly?&quot;</span>);
<a name="l01369"></a>01369 
<a name="l01370"></a>01370         url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/first&quot;] autorelease];
<a name="l01371"></a>01371         request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01372"></a>01372         [request setShouldWaitToInflateCompressedResponses:NO];
<a name="l01373"></a>01373         [request startSynchronous];
<a name="l01374"></a>01374         success = ([request rawResponseData] == [request responseData]);
<a name="l01375"></a>01375         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to populate rawResponseData with the inflated data&quot;</span>);
<a name="l01376"></a>01376 }
<a name="l01377"></a>01377 
<a name="l01378"></a>01378 
<a name="l01379"></a>01379 - (void)testPartialFetch
<a name="l01380"></a>01380 {
<a name="l01381"></a>01381         <span class="comment">// We run tests that measure progress on the main thread because otherwise we can&#39;t depend on the progress delegate being notified before we need to test it&#39;s working</span>
<a name="l01382"></a>01382         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(performPartialFetchTest) withObject:nil waitUntilDone:YES]; 
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 }
<a name="l01385"></a>01385                                         
<a name="l01386"></a>01386 - (void)performPartialFetchTest
<a name="l01387"></a>01387 {
<a name="l01388"></a>01388         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *downloadPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;testfile.txt&quot;];
<a name="l01389"></a>01389         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *tempPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;tempfile.txt&quot;];
<a name="l01390"></a>01390         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *partialContent = <span class="stringliteral">@&quot;This file should be exactly 163 bytes long when encoded as UTF8, Unix line breaks with no BOM.\n&quot;</span>;
<a name="l01391"></a>01391         [partialContent writeToFile:tempPath atomically:NO encoding:NSASCIIStringEncoding error:nil];
<a name="l01392"></a>01392         
<a name="l01393"></a>01393         progress = 0;
<a name="l01394"></a>01394         NSURL *url = [[[NSURL alloc] initWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/test_partial_download.txt&quot;] autorelease];
<a name="l01395"></a>01395         ASIHTTPRequest *request = [[[ASIHTTPRequest alloc] initWithURL:url] autorelease];
<a name="l01396"></a>01396         [request setDownloadDestinationPath:downloadPath];
<a name="l01397"></a>01397         [request setTemporaryFileDownloadPath:tempPath];
<a name="l01398"></a>01398         [request setAllowResumeForFileDownloads:YES];
<a name="l01399"></a>01399         [request setAllowCompressedResponse:NO];
<a name="l01400"></a>01400         [request setDownloadProgressDelegate:self];
<a name="l01401"></a>01401         [request startSynchronous];
<a name="l01402"></a>01402         
<a name="l01403"></a>01403         BOOL success = ([request contentLength] == 163-95);
<a name="l01404"></a>01404         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to download a segment of the data&quot;</span>);
<a name="l01405"></a>01405         
<a name="l01406"></a>01406         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *content = [<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithContentsOfFile:downloadPath encoding:NSUTF8StringEncoding error:NULL];
<a name="l01407"></a>01407         
<a name="l01408"></a>01408         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *newPartialContent = [content substringFromIndex:95];
<a name="l01409"></a>01409         success = ([newPartialContent isEqualToString:@&quot;This is the content we ought to be getting if we start from byte 95.&quot;]);
<a name="l01410"></a>01410         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to append the correct data to the end of the file?&quot;</span>);
<a name="l01411"></a>01411         
<a name="l01412"></a>01412         success = (progress == 1.0);
<a name="l01413"></a>01413         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to correctly display increment progress for a partial download&quot;</span>);
<a name="l01414"></a>01414 }
<a name="l01415"></a>01415 
<a name="l01416"></a>01416 <span class="comment">// The &#39;000&#39; is to ensure this test runs first, as another test may connect to https://selfsigned.allseeing-i.com and accept the certificate</span>
<a name="l01417"></a>01417 - (void)test000SSL
<a name="l01418"></a>01418 {
<a name="l01419"></a>01419         NSURL *url = [NSURL URLWithString:@&quot;https://selfsigned.allseeing-i.com&quot;];
<a name="l01420"></a>01420         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url];
<a name="l01421"></a>01421         [request startSynchronous];
<a name="l01422"></a>01422         
<a name="l01423"></a>01423         GHAssertNotNil([request error],<span class="stringliteral">@&quot;Failed to generate an error for a self-signed certificate (Will fail on the second run in the same session!)&quot;</span>);                
<a name="l01424"></a>01424         
<a name="l01425"></a>01425         <span class="comment">// Just for testing the request generated a custom error description - don&#39;t do this! You should look at the domain / code of the underlyingError in your own programs.</span>
<a name="l01426"></a>01426         BOOL success = ([[[request error] localizedDescription] rangeOfString:@&quot;SSL problem&quot;].location != NSNotFound);
<a name="l01427"></a>01427         GHAssertTrue(success,<span class="stringliteral">@&quot;Generated the wrong error for a self signed cert&quot;</span>);
<a name="l01428"></a>01428         
<a name="l01429"></a>01429         <span class="comment">// Turn off certificate validation, and try again</span>
<a name="l01430"></a>01430         request = [ASIHTTPRequest requestWithURL:url];
<a name="l01431"></a>01431         [request setValidatesSecureCertificate:NO];
<a name="l01432"></a>01432         [request startSynchronous];
<a name="l01433"></a>01433         
<a name="l01434"></a>01434         GHAssertNil([request error],<span class="stringliteral">@&quot;Failed to accept a self-signed certificate&quot;</span>);     
<a name="l01435"></a>01435 }
<a name="l01436"></a>01436 
<a name="l01437"></a>01437 - (void)testRedirectPreservesSession
<a name="l01438"></a>01438 {
<a name="l01439"></a>01439         <span class="comment">// Remove any old session cookies</span>
<a name="l01440"></a>01440         [ASIHTTPRequest clearSession];
<a name="l01441"></a>01441         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/session_redirect&quot;]];
<a name="l01442"></a>01442         [request startSynchronous];
<a name="l01443"></a>01443         BOOL success = [[request responseString] isEqualToString:@&quot;Take me to your leader&quot;];
<a name="l01444"></a>01444         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to redirect preserving session cookies&quot;</span>); 
<a name="l01445"></a>01445 }
<a name="l01446"></a>01446 
<a name="l01447"></a>01447 - (void)testTooMuchRedirection
<a name="l01448"></a>01448 {
<a name="l01449"></a>01449         <span class="comment">// This url will simply send a 302 redirect back to itself</span>
<a name="l01450"></a>01450         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/one_infinite_loop&quot;]];
<a name="l01451"></a>01451         [request startSynchronous];
<a name="l01452"></a>01452         GHAssertNotNil([request error],<span class="stringliteral">@&quot;Failed to generate an error when redirection occurs too many times&quot;</span>);
<a name="l01453"></a>01453         BOOL success = ([[request error] code] == ASITooMuchRedirectionErrorType);
<a name="l01454"></a>01454         GHAssertTrue(success,<span class="stringliteral">@&quot;Generated the wrong error for a redirection loop&quot;</span>);              
<a name="l01455"></a>01455 }
<a name="l01456"></a>01456 
<a name="l01457"></a>01457 - (void)testRedirectToNewDomain
<a name="l01458"></a>01458 {
<a name="l01459"></a>01459         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect_to_new_domain&quot;]];
<a name="l01460"></a>01460         [request startSynchronous];
<a name="l01461"></a>01461         BOOL success = [[[[request url] absoluteString] stringByTrimmingCharactersInSet:[NSCharacterSet characterSetWithCharactersInString:@&quot;/&quot;]] isEqualToString:@&quot;http://www.apple.com&quot;];
<a name="l01462"></a>01462         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to redirect to a different domain&quot;</span>);              
<a name="l01463"></a>01463 }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 <span class="comment">// Ensure request method changes to get</span>
<a name="l01466"></a>01466 - (void)test303Redirect
<a name="l01467"></a>01467 {
<a name="l01468"></a>01468         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect_303&quot;]];
<a name="l01469"></a>01469         [request setRequestMethod:@&quot;PUT&quot;];
<a name="l01470"></a>01470         [request appendPostData:[@&quot;Fuzzy&quot; dataUsingEncoding:NSUTF8StringEncoding]];
<a name="l01471"></a>01471         [request startSynchronous];
<a name="l01472"></a>01472         BOOL success = [[[request url] absoluteString] isEqualToString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/request-method&quot;];
<a name="l01473"></a>01473         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to redirect to correct location&quot;</span>);
<a name="l01474"></a>01474         success = [[request responseString] isEqualToString:@&quot;GET&quot;];
<a name="l01475"></a>01475         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to use GET on new URL&quot;</span>);
<a name="l01476"></a>01476 }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478 - (void)testCompressedBody
<a name="l01479"></a>01479 {
<a name="l01480"></a>01480         
<a name="l01481"></a>01481         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *content = <span class="stringliteral">@&quot;This is the test content. This is the test content. This is the test content. This is the test content.&quot;</span>;
<a name="l01482"></a>01482         
<a name="l01483"></a>01483         <span class="comment">// Test in memory compression / decompression</span>
<a name="l01484"></a>01484         <a class="code" href="class_n_s_data.html" title="For hashing raw data.">NSData</a> *data = [content dataUsingEncoding:NSUTF8StringEncoding];
<a name="l01485"></a>01485 
<a name="l01486"></a>01486         
<a name="l01487"></a>01487         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/compressed_post_body&quot;]];
<a name="l01488"></a>01488         [request setRequestMethod:@&quot;PUT&quot;];
<a name="l01489"></a>01489         [request setShouldCompressRequestBody:YES];
<a name="l01490"></a>01490         [request setShouldStreamPostDataFromDisk:YES];
<a name="l01491"></a>01491         [request setUploadProgressDelegate:self];
<a name="l01492"></a>01492         [request appendPostData:data];
<a name="l01493"></a>01493         [request startSynchronous];
<a name="l01494"></a>01494 
<a name="l01495"></a>01495         BOOL success = ([[request responseString] isEqualToString:content]);
<a name="l01496"></a>01496         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to compress the body, or server failed to decompress it&quot;</span>);
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 }
<a name="l01499"></a>01499 
<a name="l01500"></a>01500 
<a name="l01501"></a>01501 <span class="comment">// Ensure class convenience constructor returns an instance of our subclass</span>
<a name="l01502"></a>01502 - (void)testSubclass
<a name="l01503"></a>01503 {
<a name="l01504"></a>01504         ASIHTTPRequestSubclass *instance = [ASIHTTPRequestSubclass requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01505"></a>01505         BOOL success = [instance isKindOfClass:[ASIHTTPRequestSubclass class]];
<a name="l01506"></a>01506         GHAssertTrue(success,<span class="stringliteral">@&quot;Convenience constructor failed to return an instance of the correct class&quot;</span>);     
<a name="l01507"></a>01507 }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509 
<a name="l01510"></a>01510 - (void)testThrottlingDownloadBandwidth
<a name="l01511"></a>01511 {
<a name="l01512"></a>01512         [ASIHTTPRequest setMaxBandwidthPerSecond:0];
<a name="l01513"></a>01513         
<a name="l01514"></a>01514         <span class="comment">// This content is around 128KB in size, and it won&#39;t be gzipped, so it should take more than 8 seconds to download at 14.5KB / second</span>
<a name="l01515"></a>01515         <span class="comment">// We&#39;ll test first without throttling</span>
<a name="l01516"></a>01516         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel_%28abridged%29.txt&quot;]];
<a name="l01517"></a>01517         NSDate *date = [NSDate date];
<a name="l01518"></a>01518         [request startSynchronous];     
<a name="l01519"></a>01519         
<a name="l01520"></a>01520         NSTimeInterval interval =[date timeIntervalSinceNow];
<a name="l01521"></a>01521         BOOL success = (interval &gt; -7);
<a name="l01522"></a>01522         GHAssertTrue(success,<span class="stringliteral">@&quot;Downloaded the file too slowly - either this is a bug, or your internet connection is too slow to run this test (must be able to download 128KB in less than 7 seconds, without throttling)&quot;</span>);
<a name="l01523"></a>01523         
<a name="l01524"></a>01524         <span class="comment">// Now we&#39;ll test with throttling</span>
<a name="l01525"></a>01525         [ASIHTTPRequest setMaxBandwidthPerSecond:ASIWWANBandwidthThrottleAmount];
<a name="l01526"></a>01526         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel_%28abridged%29.txt&quot;]];
<a name="l01527"></a>01527         date = [NSDate date];
<a name="l01528"></a>01528         [request startSynchronous];     
<a name="l01529"></a>01529         
<a name="l01530"></a>01530         [ASIHTTPRequest setMaxBandwidthPerSecond:0];
<a name="l01531"></a>01531         
<a name="l01532"></a>01532         interval =[date timeIntervalSinceNow];
<a name="l01533"></a>01533         success = (interval &lt; -7);
<a name="l01534"></a>01534         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to throttle download&quot;</span>);           
<a name="l01535"></a>01535         GHAssertNil([request error],<span class="stringliteral">@&quot;Request generated an error - timeout?&quot;</span>);  
<a name="l01536"></a>01536         
<a name="l01537"></a>01537 }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539 - (void)testThrottlingUploadBandwidth
<a name="l01540"></a>01540 {
<a name="l01541"></a>01541         [ASIHTTPRequest setMaxBandwidthPerSecond:0];
<a name="l01542"></a>01542         
<a name="l01543"></a>01543         <span class="comment">// Create a 64KB request body</span>
<a name="l01544"></a>01544         <a class="code" href="class_n_s_data.html" title="For hashing raw data.">NSData</a> *data = [[[NSMutableData alloc] initWithLength:64*1024] autorelease];
<a name="l01545"></a>01545         
<a name="l01546"></a>01546         <span class="comment">// We&#39;ll test first without throttling</span>
<a name="l01547"></a>01547         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ignore&quot;]];
<a name="l01548"></a>01548         [request appendPostData:data];
<a name="l01549"></a>01549         NSDate *date = [NSDate date];
<a name="l01550"></a>01550         [request startSynchronous];     
<a name="l01551"></a>01551         
<a name="l01552"></a>01552         NSTimeInterval interval =[date timeIntervalSinceNow];
<a name="l01553"></a>01553         BOOL success = (interval &gt; -3);
<a name="l01554"></a>01554         GHAssertTrue(success,<span class="stringliteral">@&quot;Uploaded the data too slowly - either this is a bug, or your internet connection is too slow to run this test (must be able to upload 64KB in less than 3 seconds, without throttling)&quot;</span>);
<a name="l01555"></a>01555         
<a name="l01556"></a>01556         <span class="comment">// Now we&#39;ll test with throttling</span>
<a name="l01557"></a>01557         [ASIHTTPRequest setMaxBandwidthPerSecond:ASIWWANBandwidthThrottleAmount];
<a name="l01558"></a>01558         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ignore&quot;]];
<a name="l01559"></a>01559         [request appendPostData:data];
<a name="l01560"></a>01560         date = [NSDate date];
<a name="l01561"></a>01561         [request startSynchronous];     
<a name="l01562"></a>01562         
<a name="l01563"></a>01563         [ASIHTTPRequest setMaxBandwidthPerSecond:0];
<a name="l01564"></a>01564         
<a name="l01565"></a>01565         interval =[date timeIntervalSinceNow];
<a name="l01566"></a>01566         success = (interval &lt; -3);
<a name="l01567"></a>01567         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to throttle upload&quot;</span>);             
<a name="l01568"></a>01568         GHAssertNil([request error],<span class="stringliteral">@&quot;Request generated an error - timeout?&quot;</span>);  
<a name="l01569"></a>01569 }
<a name="l01570"></a>01570 
<a name="l01571"></a>01571 
<a name="l01572"></a>01572 - (void)testFetchToInvalidPath
<a name="l01573"></a>01573 {
<a name="l01574"></a>01574         <span class="comment">// Test gzipped content</span>
<a name="l01575"></a>01575         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01576"></a>01576         [request setDownloadDestinationPath:@&quot;/an/invalid/location.html&quot;];
<a name="l01577"></a>01577         [request startSynchronous];
<a name="l01578"></a>01578         GHAssertNotNil([request error],<span class="stringliteral">@&quot;Failed to generate an authentication when attempting to write to an invalid location&quot;</span>);        
<a name="l01579"></a>01579         
<a name="l01580"></a>01580         <span class="comment">//Test non-gzipped content</span>
<a name="l01581"></a>01581         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/i/logo.png&quot;]];
<a name="l01582"></a>01582         [request setDownloadDestinationPath:@&quot;/an/invalid/location.png&quot;];
<a name="l01583"></a>01583         [request startSynchronous];
<a name="l01584"></a>01584         GHAssertNotNil([request error],<span class="stringliteral">@&quot;Failed to generate an authentication when attempting to write to an invalid location&quot;</span>);                
<a name="l01585"></a>01585 }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 - (void)testResponseStatusMessage
<a name="l01588"></a>01588 {
<a name="l01589"></a>01589         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/the-meaning-of-life&quot;]];
<a name="l01590"></a>01590         [request startSynchronous];     
<a name="l01591"></a>01591         BOOL success = [[request responseStatusMessage] isEqualToString:@&quot;HTTP/1.0 404 Not Found&quot;];
<a name="l01592"></a>01592         GHAssertTrue(success,<span class="stringliteral">@&quot;Got wrong response status message&quot;</span>);
<a name="l01593"></a>01593 }
<a name="l01594"></a>01594 
<a name="l01595"></a>01595 - (void)testAsynchronous
<a name="l01596"></a>01596 {
<a name="l01597"></a>01597         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/first&quot;]];
<a name="l01598"></a>01598         [request setTag:1];
<a name="l01599"></a>01599         [request setDidFailSelector:@selector(asyncFail:)];
<a name="l01600"></a>01600         [request setDidFinishSelector:@selector(asyncSuccess:)];
<a name="l01601"></a>01601         [request setDelegate:self];
<a name="l01602"></a>01602         [request startAsynchronous];
<a name="l01603"></a>01603         
<a name="l01604"></a>01604         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/second&quot;]];
<a name="l01605"></a>01605         [request setTag:2];
<a name="l01606"></a>01606         [request setDidFailSelector:@selector(asyncFail:)];
<a name="l01607"></a>01607         [request setDidFinishSelector:@selector(asyncSuccess:)];
<a name="l01608"></a>01608         [request setDelegate:self];
<a name="l01609"></a>01609         [request startAsynchronous];
<a name="l01610"></a>01610         
<a name="l01611"></a>01611         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/third&quot;]];
<a name="l01612"></a>01612         [request setTag:3];
<a name="l01613"></a>01613         [request setDidFailSelector:@selector(asyncFail:)];
<a name="l01614"></a>01614         [request setDidFinishSelector:@selector(asyncSuccess:)];
<a name="l01615"></a>01615         [request setDelegate:self];
<a name="l01616"></a>01616         [request startAsynchronous];    
<a name="l01617"></a>01617         
<a name="l01618"></a>01618         request = [ASIHTTPRequest requestWithURL:nil];
<a name="l01619"></a>01619         [request setTag:4];
<a name="l01620"></a>01620         [request setDidFailSelector:@selector(asyncFail:)];
<a name="l01621"></a>01621         [request setDidFinishSelector:@selector(asyncSuccess:)];
<a name="l01622"></a>01622         [request setDelegate:self];
<a name="l01623"></a>01623         [request startAsynchronous];    
<a name="l01624"></a>01624 }
<a name="l01625"></a>01625 
<a name="l01626"></a>01626 
<a name="l01627"></a>01627 - (void)asyncFail:(ASIHTTPRequest *)request
<a name="l01628"></a>01628 {
<a name="l01629"></a>01629         BOOL success = ([request tag] == 4);
<a name="l01630"></a>01630         GHAssertTrue(success,<span class="stringliteral">@&quot;Wrong request failed&quot;</span>);
<a name="l01631"></a>01631 }
<a name="l01632"></a>01632 
<a name="l01633"></a>01633 - (void)asyncSuccess:(ASIHTTPRequest *)request
<a name="l01634"></a>01634 {
<a name="l01635"></a>01635         BOOL success = ([request tag] != 4);
<a name="l01636"></a>01636         GHAssertTrue(success,<span class="stringliteral">@&quot;Request succeeded when it should have failed&quot;</span>);
<a name="l01637"></a>01637         
<a name="l01638"></a>01638         <span class="keywordflow">switch</span> ([request tag]) {
<a name="l01639"></a>01639                 <span class="keywordflow">case</span> 1:
<a name="l01640"></a>01640                         success = [[request responseString] isEqualToString:@&quot;This is the expected content for the first string&quot;];
<a name="l01641"></a>01641                         <span class="keywordflow">break</span>;
<a name="l01642"></a>01642                 <span class="keywordflow">case</span> 2:
<a name="l01643"></a>01643                         success = [[request responseString] isEqualToString:@&quot;This is the expected content for the second string&quot;];
<a name="l01644"></a>01644                         <span class="keywordflow">break</span>;
<a name="l01645"></a>01645                 <span class="keywordflow">case</span> 3:
<a name="l01646"></a>01646                         success = [[request responseString] isEqualToString:@&quot;This is the expected content for the third string&quot;];
<a name="l01647"></a>01647                         <span class="keywordflow">break</span>;
<a name="l01648"></a>01648         }
<a name="l01649"></a>01649         GHAssertTrue(success,<span class="stringliteral">@&quot;Got wrong request content - very bad!&quot;</span>);
<a name="l01650"></a>01650         
<a name="l01651"></a>01651 }
<a name="l01652"></a>01652 
<a name="l01653"></a>01653 
<a name="l01654"></a>01654 
<a name="l01655"></a>01655 <span class="comment">// Will be called on Mac OS</span>
<a name="l01656"></a>01656 - (void)setDoubleValue:(<span class="keywordtype">double</span>)newProgress;
<a name="l01657"></a>01657 {
<a name="l01658"></a>01658         progress = (float)newProgress;
<a name="l01659"></a>01659 }
<a name="l01660"></a>01660 
<a name="l01661"></a>01661 <span class="comment">// Will be called on iPhone OS</span>
<a name="l01662"></a>01662 - (void)setProgress:(<span class="keywordtype">float</span>)newProgress;
<a name="l01663"></a>01663 {
<a name="l01664"></a>01664         progress = newProgress;
<a name="l01665"></a>01665 }
<a name="l01666"></a>01666 
<a name="l01667"></a>01667 <span class="preprocessor">#if TARGET_OS_IPHONE</span>
<a name="l01668"></a>01668 <span class="preprocessor"></span>- (void)testReachability
<a name="l01669"></a>01669 {
<a name="l01670"></a>01670 <span class="preprocessor">#if REACHABILITY_20_API</span>
<a name="l01671"></a>01671 <span class="preprocessor"></span>        NSLog(<span class="stringliteral">@&quot;Using Reachability 2.0 API&quot;</span>);
<a name="l01672"></a>01672 <span class="preprocessor">#else</span>
<a name="l01673"></a>01673 <span class="preprocessor"></span>        NSLog(<span class="stringliteral">@&quot;Using Reachability 1.5 API&quot;</span>);
<a name="l01674"></a>01674 <span class="preprocessor">#endif</span>
<a name="l01675"></a>01675 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ([ASIHTTPRequest isNetworkReachableViaWWAN]) {
<a name="l01676"></a>01676                 NSLog(<span class="stringliteral">@&quot;Connected via WWAN&quot;</span>);
<a name="l01677"></a>01677         } <span class="keywordflow">else</span> {
<a name="l01678"></a>01678                 NSLog(<span class="stringliteral">@&quot;Not connected via WWAN&quot;</span>);
<a name="l01679"></a>01679         }
<a name="l01680"></a>01680 }
<a name="l01681"></a>01681 <span class="preprocessor">#endif</span>
<a name="l01682"></a>01682 <span class="preprocessor"></span>
<a name="l01683"></a>01683 - (void)testAutomaticRetry
<a name="l01684"></a>01684 {
<a name="l01685"></a>01685         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01686"></a>01686         [request setTimeOutSeconds:0.001];
<a name="l01687"></a>01687         [request setNumberOfTimesToRetryOnTimeout:5];
<a name="l01688"></a>01688         [request startSynchronous];
<a name="l01689"></a>01689         GHAssertNotNil([request error],<span class="stringliteral">@&quot;Request failed to timeout, cannot proceed with test&quot;</span>);
<a name="l01690"></a>01690         BOOL success = ([request retryCount] == 5);
<a name="l01691"></a>01691         GHAssertTrue(success,<span class="stringliteral">@&quot;Request failed to retry on timeout&quot;</span>);
<a name="l01692"></a>01692 }
<a name="l01693"></a>01693 
<a name="l01694"></a>01694 - (void)testCopy
<a name="l01695"></a>01695 {
<a name="l01696"></a>01696         NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
<a name="l01697"></a>01697         
<a name="l01698"></a>01698         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01699"></a>01699         ASIHTTPRequest *request2 = [request copy];
<a name="l01700"></a>01700         
<a name="l01701"></a>01701         [pool release];
<a name="l01702"></a>01702         
<a name="l01703"></a>01703         GHAssertNotNil(request2,<span class="stringliteral">@&quot;Failed to create a copy&quot;</span>);
<a name="l01704"></a>01704         BOOL success = ([request2 retainCount] == 1);
<a name="l01705"></a>01705         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to create a retained copy&quot;</span>);
<a name="l01706"></a>01706         
<a name="l01707"></a>01707         [request2 release];
<a name="l01708"></a>01708 }
<a name="l01709"></a>01709 
<a name="l01710"></a>01710 - (void)testCloseConnection
<a name="l01711"></a>01711 {
<a name="l01712"></a>01712         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/close-connection&quot;]];
<a name="l01713"></a>01713         [request startSynchronous];
<a name="l01714"></a>01714         
<a name="l01715"></a>01715         BOOL success = ![request connectionCanBeReused];
<a name="l01716"></a>01716         GHAssertTrue(success,<span class="stringliteral">@&quot;Should not be able to re-use a request sent with Connection:close&quot;</span>);
<a name="l01717"></a>01717         
<a name="l01718"></a>01718         <span class="comment">// Ensure we close the connection when authentication is needed</span>
<a name="l01719"></a>01719         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/close-connection-auth-needed&quot;]];
<a name="l01720"></a>01720         [request startSynchronous];
<a name="l01721"></a>01721         
<a name="l01722"></a>01722         success = ![request connectionCanBeReused];
<a name="l01723"></a>01723         GHAssertTrue(success,<span class="stringliteral">@&quot;Should not be able to re-use a request sent with Connection:close&quot;</span>);
<a name="l01724"></a>01724         
<a name="l01725"></a>01725 }
<a name="l01726"></a>01726 
<a name="l01727"></a>01727 - (void)testPersistentConnections
<a name="l01728"></a>01728 {
<a name="l01729"></a>01729         <span class="comment">// allseeing-i.com is configured to keep persistent connections alive for 2 seconds</span>
<a name="l01730"></a>01730 
<a name="l01731"></a>01731         <span class="comment">// Ensure we parse a keep-alive header</span>
<a name="l01732"></a>01732         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01733"></a>01733 
<a name="l01734"></a>01734         BOOL success = ([request persistentConnectionTimeoutSeconds] == 60);
<a name="l01735"></a>01735         GHAssertTrue(success,<span class="stringliteral">@&quot;Request failed to default to 60 seconds for connection timeout&quot;</span>);
<a name="l01736"></a>01736 
<a name="l01737"></a>01737         [request startSynchronous];
<a name="l01738"></a>01738 
<a name="l01739"></a>01739         NSNumber *connectionId = [request connectionID];
<a name="l01740"></a>01740 
<a name="l01741"></a>01741         success = ([request persistentConnectionTimeoutSeconds] == 2);
<a name="l01742"></a>01742         GHAssertTrue(success,<span class="stringliteral">@&quot;Request failed to use time out set by server&quot;</span>);
<a name="l01743"></a>01743 
<a name="l01744"></a>01744         <span class="comment">// Wait 3 seconds - connection should have timed out</span>
<a name="l01745"></a>01745         sleep(3);
<a name="l01746"></a>01746 
<a name="l01747"></a>01747         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01748"></a>01748         [request startSynchronous];
<a name="l01749"></a>01749 
<a name="l01750"></a>01750         success = ([[request connectionID] intValue] != [connectionId intValue]);
<a name="l01751"></a>01751         GHAssertTrue(success,<span class="stringliteral">@&quot;Reused a connection that should have timed out&quot;</span>);
<a name="l01752"></a>01752 
<a name="l01753"></a>01753         <span class="comment">// Ensure persistent connections are turned off by default with POST/PUT and/or a request body</span>
<a name="l01754"></a>01754         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01755"></a>01755         [request appendPostData:[@&quot;Foo&quot; dataUsingEncoding:NSUTF8StringEncoding]];
<a name="l01756"></a>01756         [request startSynchronous];
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         success = ![request shouldAttemptPersistentConnection];
<a name="l01759"></a>01759         GHAssertTrue(success,<span class="stringliteral">@&quot;Used a persistent connection with a body&quot;</span>);
<a name="l01760"></a>01760 
<a name="l01761"></a>01761         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01762"></a>01762         [request setRequestMethod:@&quot;PUT&quot;];
<a name="l01763"></a>01763         [request startSynchronous];
<a name="l01764"></a>01764 
<a name="l01765"></a>01765         success = ![request shouldAttemptPersistentConnection];
<a name="l01766"></a>01766         GHAssertTrue(success,<span class="stringliteral">@&quot;Used a persistent connection with PUT&quot;</span>);
<a name="l01767"></a>01767 
<a name="l01768"></a>01768         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01769"></a>01769         [request setRequestMethod:@&quot;POST&quot;];
<a name="l01770"></a>01770         [request startSynchronous];
<a name="l01771"></a>01771 
<a name="l01772"></a>01772         success = ![request shouldAttemptPersistentConnection];
<a name="l01773"></a>01773         GHAssertTrue(success,<span class="stringliteral">@&quot;Used a persistent connection with POST&quot;</span>);
<a name="l01774"></a>01774 
<a name="l01775"></a>01775         <span class="comment">// Ensure we can force a persistent connection</span>
<a name="l01776"></a>01776         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01777"></a>01777         [request setRequestMethod:@&quot;POST&quot;];
<a name="l01778"></a>01778         [request setShouldAttemptPersistentConnection:YES];
<a name="l01779"></a>01779         [request startSynchronous];
<a name="l01780"></a>01780 
<a name="l01781"></a>01781         success = [request shouldAttemptPersistentConnection];
<a name="l01782"></a>01782         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to use a persistent connection&quot;</span>);
<a name="l01783"></a>01783 }
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 - (void)testRemoveUploadProgress
<a name="l01786"></a>01786 {
<a name="l01787"></a>01787         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(runRemoveUploadProgressTest) withObject:nil waitUntilDone:YES];
<a name="l01788"></a>01788 }
<a name="l01789"></a>01789 
<a name="l01790"></a>01790 - (void)runRemoveUploadProgressTest
<a name="l01791"></a>01791 {
<a name="l01792"></a>01792         progress = 0;
<a name="l01793"></a>01793         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01794"></a>01794         <a class="code" href="class_n_s_data.html" title="For hashing raw data.">NSData</a> *data = [[[NSMutableData alloc] initWithLength:64*1024] autorelease];
<a name="l01795"></a>01795         [request appendPostData:data];
<a name="l01796"></a>01796         [request setRequestMethod:@&quot;POST&quot;];
<a name="l01797"></a>01797         [request setUploadProgressDelegate:self];
<a name="l01798"></a>01798         [request startSynchronous];
<a name="l01799"></a>01799         
<a name="l01800"></a>01800         BOOL success = (progress == 1.0);
<a name="l01801"></a>01801         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to set upload progress, cannot proceed with test&quot;</span>);
<a name="l01802"></a>01802         
<a name="l01803"></a>01803         [request removeUploadProgressSoFar];
<a name="l01804"></a>01804         success = (progress == 0);
<a name="l01805"></a>01805         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to set upload progress, cannot proceed with test&quot;</span>);
<a name="l01806"></a>01806 }
<a name="l01807"></a>01807 
<a name="l01808"></a>01808 - (void)testMimeType
<a name="l01809"></a>01809 {
<a name="l01810"></a>01810         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *text = <span class="stringliteral">@&quot;This is my content&quot;</span>;
<a name="l01811"></a>01811         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *filePath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;testfile.txt&quot;];
<a name="l01812"></a>01812         [[text dataUsingEncoding:NSUTF8StringEncoding] writeToFile:filePath atomically:NO];
<a name="l01813"></a>01813         
<a name="l01814"></a>01814         BOOL success = ([[ASIHTTPRequest mimeTypeForFileAtPath:filePath] isEqualToString:@&quot;text/plain&quot;]);
<a name="l01815"></a>01815         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to detect the mime type for a file&quot;</span>);
<a name="l01816"></a>01816         
<a name="l01817"></a>01817         filePath = <span class="stringliteral">@&quot;/nowhere&quot;</span>;
<a name="l01818"></a>01818         success = (![ASIHTTPRequest mimeTypeForFileAtPath:filePath]);
<a name="l01819"></a>01819         GHAssertTrue(success,<span class="stringliteral">@&quot;Returned a mime type for a non-existent file&quot;</span>);
<a name="l01820"></a>01820         
<a name="l01821"></a>01821         filePath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;testfile&quot;];
<a name="l01822"></a>01822         [[text dataUsingEncoding:NSUTF8StringEncoding] writeToFile:filePath atomically:NO];
<a name="l01823"></a>01823         success = ([[ASIHTTPRequest mimeTypeForFileAtPath:filePath] isEqualToString:@&quot;application/octet-stream&quot;]);
<a name="l01824"></a>01824         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to return the default mime type when a file has no extension&quot;</span>);
<a name="l01825"></a>01825 }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827 - (void)testDelegateResponseDataHandling
<a name="l01828"></a>01828 {
<a name="l01829"></a>01829         [<span class="keyword">self</span> setResponseData:[NSMutableData dataWithLength:0]];
<a name="l01830"></a>01830         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel_%28young_readers_edition%29.txt&quot;]];
<a name="l01831"></a>01831         [request setDelegate:self];
<a name="l01832"></a>01832         [request setDidReceiveDataSelector:@selector(theTestRequest:didReceiveData:)];
<a name="l01833"></a>01833         [request setDidFinishSelector:@selector(theTestRequestFinished:)];
<a name="l01834"></a>01834         [request startAsynchronous];
<a name="l01835"></a>01835 }
<a name="l01836"></a>01836 
<a name="l01837"></a>01837 - (void)theTestRequestFinished:(ASIHTTPRequest *)request
<a name="l01838"></a>01838 {
<a name="l01839"></a>01839         ASIHTTPRequest *request2 = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/the_great_american_novel_%28young_readers_edition%29.txt&quot;]];
<a name="l01840"></a>01840         [request2 startSynchronous];
<a name="l01841"></a>01841         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *firstResponse = [[[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> alloc] initWithBytes:[[<span class="keyword">self</span> responseData] bytes] length:[[<span class="keyword">self</span> responseData] length] encoding:[request responseEncoding]] autorelease];
<a name="l01842"></a>01842         BOOL success = [[request2 responseString] isEqualToString:firstResponse];
<a name="l01843"></a>01843         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to correctly download and store the response using a delegate&quot;</span>);
<a name="l01844"></a>01844 }
<a name="l01845"></a>01845 
<a name="l01846"></a>01846 - (void)theTestRequest:(ASIHTTPRequest *)request didReceiveData:(<a class="code" href="class_n_s_data.html" title="For hashing raw data.">NSData</a> *)data
<a name="l01847"></a>01847 {
<a name="l01848"></a>01848         [[<span class="keyword">self</span> responseData] appendData:data];
<a name="l01849"></a>01849 }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851 
<a name="l01852"></a>01852 - (void)testNilPortCredentialsMatching
<a name="l01853"></a>01853 {
<a name="l01854"></a>01854         <span class="comment">// Test for http://github.com/pokeb/asi-http-request/issues#issue/39</span>
<a name="l01855"></a>01855         [ASIHTTPRequest clearSession];
<a name="l01856"></a>01856         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com:80/ASIHTTPRequest/tests/basic-authentication&quot;]];
<a name="l01857"></a>01857         [request setUsername:@&quot;secret_username&quot;];
<a name="l01858"></a>01858         [request setPassword:@&quot;secret_password&quot;];
<a name="l01859"></a>01859         [request startSynchronous];
<a name="l01860"></a>01860 
<a name="l01861"></a>01861         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/basic-authentication&quot;]];
<a name="l01862"></a>01862         [request startSynchronous];
<a name="l01863"></a>01863 
<a name="l01864"></a>01864         <span class="comment">// Now let&#39;s test the other way around</span>
<a name="l01865"></a>01865         [ASIHTTPRequest clearSession];
<a name="l01866"></a>01866 
<a name="l01867"></a>01867         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com:/ASIHTTPRequest/tests/basic-authentication&quot;]];
<a name="l01868"></a>01868         [request setUsername:@&quot;secret_username&quot;];
<a name="l01869"></a>01869         [request setPassword:@&quot;secret_password&quot;];
<a name="l01870"></a>01870         [request startSynchronous];
<a name="l01871"></a>01871 
<a name="l01872"></a>01872         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com:80/ASIHTTPRequest/tests/basic-authentication&quot;]];
<a name="l01873"></a>01873         [request startSynchronous];
<a name="l01874"></a>01874 }
<a name="l01875"></a>01875 
<a name="l01876"></a>01876 
<a name="l01877"></a>01877 - (void)testRFC1123DateParsing
<a name="l01878"></a>01878 {
<a name="l01879"></a>01879         <span class="keywordtype">unsigned</span> dateUnits = NSYearCalendarUnit | NSMonthCalendarUnit |  NSDayCalendarUnit | NSHourCalendarUnit | NSMinuteCalendarUnit | NSSecondCalendarUnit | NSWeekdayCalendarUnit;
<a name="l01880"></a>01880         NSCalendar *calendar = [[[NSCalendar alloc] initWithCalendarIdentifier:NSGregorianCalendar] autorelease];
<a name="l01881"></a>01881         [calendar setTimeZone:[NSTimeZone timeZoneForSecondsFromGMT:0]];
<a name="l01882"></a>01882         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *dateString = <span class="stringliteral">@&quot;Thu, 19 Nov 1981 08:52:01 GMT&quot;</span>;
<a name="l01883"></a>01883         NSDate *date = [ASIHTTPRequest dateFromRFC1123String:dateString];
<a name="l01884"></a>01884         NSDateComponents *components = [calendar components:dateUnits fromDate:date];
<a name="l01885"></a>01885         BOOL success = ([components year] == 1981 &amp;&amp; [components month] == 11 &amp;&amp; [components day] == 19 &amp;&amp; [components weekday] == 5 &amp;&amp; [components hour] == 8 &amp;&amp; [components minute] == 52 &amp;&amp; [components second] == 1);
<a name="l01886"></a>01886         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to parse an RFC1123 date correctly&quot;</span>);
<a name="l01887"></a>01887 
<a name="l01888"></a>01888         dateString = <span class="stringliteral">@&quot;4 May 2010 00:59 CET&quot;</span>;
<a name="l01889"></a>01889         date = [ASIHTTPRequest dateFromRFC1123String:dateString];
<a name="l01890"></a>01890         components = [calendar components:dateUnits fromDate:date];
<a name="l01891"></a>01891         success = ([components year] == 2010 &amp;&amp; [components month] == 5 &amp;&amp; [components day] == 3 &amp;&amp; [components hour] == 23 &amp;&amp; [components minute] == 59);
<a name="l01892"></a>01892         GHAssertTrue(success,<span class="stringliteral">@&quot;Failed to parse an RFC1123 date correctly&quot;</span>);
<a name="l01893"></a>01893 
<a name="l01894"></a>01894 }
<a name="l01895"></a>01895 
<a name="l01896"></a>01896 - (void)testAccurateProgressFallback
<a name="l01897"></a>01897 {
<a name="l01898"></a>01898         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01899"></a>01899         [request setAllowCompressedResponse:NO]; <span class="comment">// A bit hacky - my server will send a chunked response (without content length) when we don&#39;t specify that we accept gzip</span>
<a name="l01900"></a>01900         [request startSynchronous];
<a name="l01901"></a>01901 
<a name="l01902"></a>01902         BOOL success = ([request showAccurateProgress] == NO);
<a name="l01903"></a>01903         GHAssertTrue(success,<span class="stringliteral">@&quot;Request failed to fall back to simple progress&quot;</span>);
<a name="l01904"></a>01904 
<a name="l01905"></a>01905         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect_resume&quot;]];
<a name="l01906"></a>01906         [request startSynchronous];
<a name="l01907"></a>01907 
<a name="l01908"></a>01908         success = ([request showAccurateProgress] == YES);
<a name="l01909"></a>01909         GHAssertTrue(success,<span class="stringliteral">@&quot;Request fell back to simple progress when redirecting&quot;</span>);
<a name="l01910"></a>01910 }
<a name="l01911"></a>01911 
<a name="l01912"></a>01912 <span class="comment">// Because of they way I implemented the server part of this test, I&#39;m afraid you won&#39;t be able to run it yourself</span>
<a name="l01913"></a>01913 
<a name="l01914"></a>01914 - (void)testResumeWithAutomaticTimeoutRetry
<a name="l01915"></a>01915 {
<a name="l01916"></a>01916         printf(<span class="stringliteral">&quot;\nSkipping testResumeWithAutomaticTimeoutRetry - &quot;</span>);
<a name="l01917"></a>01917         <span class="keywordflow">return</span>;
<a name="l01918"></a>01918         <span class="comment">// Get the first part of the response</span>
<a name="l01919"></a>01919         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/resume-with-timeout&quot;]];
<a name="l01920"></a>01920         [request setAllowCompressedResponse:NO];
<a name="l01921"></a>01921         [request startSynchronous];
<a name="l01922"></a>01922 
<a name="l01923"></a>01923         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *partialPath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;partial.txt&quot;];
<a name="l01924"></a>01924         [[request responseString] writeToFile:partialPath atomically:NO encoding:NSUTF8StringEncoding error:NULL];
<a name="l01925"></a>01925 
<a name="l01926"></a>01926         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *completePath = [[<span class="keyword">self</span> filePathForTemporaryTestFiles] stringByAppendingPathComponent:@&quot;complete.txt&quot;];
<a name="l01927"></a>01927 
<a name="l01928"></a>01928         request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/resume-with-timeout-finish&quot;]];
<a name="l01929"></a>01929         [request setAllowCompressedResponse:NO];
<a name="l01930"></a>01930         [request setAllowResumeForFileDownloads:YES];
<a name="l01931"></a>01931         [request setTemporaryFileDownloadPath:partialPath];
<a name="l01932"></a>01932         [request setDownloadDestinationPath:completePath];
<a name="l01933"></a>01933         [request setNumberOfTimesToRetryOnTimeout:1];
<a name="l01934"></a>01934         [request startSynchronous];
<a name="l01935"></a>01935 
<a name="l01936"></a>01936         <a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> *expectedOutput = <span class="stringliteral">@&quot;&quot;</span>;
<a name="l01937"></a>01937 
<a name="l01938"></a>01938         <span class="keywordtype">char</span> i;
<a name="l01939"></a>01939         <span class="keywordflow">for</span> (i=0; i&lt;3; i++) {
<a name="l01940"></a>01940                 <span class="keywordtype">char</span> *s;
<a name="l01941"></a>01941                 s = (<span class="keywordtype">char</span> *)malloc(1024*128);
<a name="l01942"></a>01942                 memset(s, i+49, 1024*128);
<a name="l01943"></a>01943                 expectedOutput = [expectedOutput stringByAppendingString:[[[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> alloc] initWithBytes:s length:1024*128 encoding:NSUTF8StringEncoding] autorelease]];
<a name="l01944"></a>01944                 expectedOutput = [expectedOutput stringByAppendingString:@&quot;\r\n&quot;];
<a name="l01945"></a>01945                 free(s);
<a name="l01946"></a>01946         }
<a name="l01947"></a>01947 
<a name="l01948"></a>01948         BOOL success = [expectedOutput isEqualToString:[<a class="code" href="class_n_s_string.html" title="For manipulating NSStrings.">NSString</a> stringWithContentsOfFile:completePath encoding:NSUTF8StringEncoding error:NULL]];
<a name="l01949"></a>01949         GHAssertTrue(success, <span class="stringliteral">@&quot;Failed to send the correct Range headers to the server when resuming after a timeout&quot;</span>);
<a name="l01950"></a>01950 }
<a name="l01951"></a>01951 
<a name="l01952"></a>01952 - (void)testChangeURLOnAuthenticationRetry
<a name="l01953"></a>01953 {
<a name="l01954"></a>01954         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/basic-authentication&quot;]];
<a name="l01955"></a>01955         [request setDelegate:self];
<a name="l01956"></a>01956         [request setValidatesSecureCertificate:NO];
<a name="l01957"></a>01957         [request startAsynchronous];
<a name="l01958"></a>01958 }
<a name="l01959"></a>01959 
<a name="l01960"></a>01960 - (void)changeURLFailed:(ASIHTTPRequest *)request
<a name="l01961"></a>01961 {
<a name="l01962"></a>01962         GHFail(<span class="stringliteral">@&quot;Request failed when changing url&quot;</span>);
<a name="l01963"></a>01963 }
<a name="l01964"></a>01964 
<a name="l01965"></a>01965 - (void)authenticationNeededForRequest:(ASIHTTPRequest *)request
<a name="l01966"></a>01966 {
<a name="l01967"></a>01967         [request setUsername:@&quot;foo&quot;];
<a name="l01968"></a>01968         [request setPassword:@&quot;foo&quot;];
<a name="l01969"></a>01969         [request setDidFailSelector:@selector(changeURLFailed:)];
<a name="l01970"></a>01970         [request setURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01971"></a>01971         [request retryUsingSuppliedCredentials];
<a name="l01972"></a>01972 }
<a name="l01973"></a>01973 
<a name="l01974"></a>01974 - (void)testDelegateRedirectHandling
<a name="l01975"></a>01975 {
<a name="l01976"></a>01976         ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:[NSURL URLWithString:@&quot;http://allseeing-i.com/ASIHTTPRequest/tests/redirect_to_ssl&quot;]];
<a name="l01977"></a>01977         [request setDelegate:self];
<a name="l01978"></a>01978         [request setWillRedirectSelector:@selector(request:isGoingToRedirectToURL:)];
<a name="l01979"></a>01979         [request setDidFailSelector:@selector(redirectURLTestFailed:)];
<a name="l01980"></a>01980         [request setDidFinishSelector:@selector(redirectURLTestSucceeded:)];
<a name="l01981"></a>01981         [request startAsynchronous];
<a name="l01982"></a>01982 }
<a name="l01983"></a>01983 
<a name="l01984"></a>01984 - (void)redirectURLTestSucceeded:(ASIHTTPRequest *)request
<a name="l01985"></a>01985 {
<a name="l01986"></a>01986         BOOL success = [[request url] isEqual:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01987"></a>01987         GHAssertTrue(success,<span class="stringliteral">@&quot;Request failed to redirect to url specified by delegate&quot;</span>);
<a name="l01988"></a>01988 }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990 - (void)redirectURLTestFailed:(ASIHTTPRequest *)request
<a name="l01991"></a>01991 {
<a name="l01992"></a>01992         GHFail(<span class="stringliteral">@&quot;Request failed, cannot proceed with test&quot;</span>);
<a name="l01993"></a>01993 }
<a name="l01994"></a>01994 
<a name="l01995"></a>01995 - (void)request:(ASIHTTPRequest *)request isGoingToRedirectToURL:(NSURL *)url
<a name="l01996"></a>01996 {
<a name="l01997"></a>01997         [request redirectToURL:[NSURL URLWithString:@&quot;http://allseeing-i.com&quot;]];
<a name="l01998"></a>01998 }
<a name="l01999"></a>01999 
<a name="l02000"></a>02000 <span class="keyword">@synthesize</span> responseData;
<a name="l02001"></a>02001 <span class="keyword">@end</span>
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><b>ASIHTTPRequestTests.m</b>      </li>
</div><!-- .fixedwidth -->


    <span class="footer">Generated for Nimbus by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4-20110629 </span>
   </ul>
 </div>


</div> <!-- page -->
</body>
</html>
